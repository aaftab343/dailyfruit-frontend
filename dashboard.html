<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard — Daily Fruit Co.</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <!-- Icons -->
  <script src="https://kit.fontawesome.com/0c9b1f3f2d.js" crossorigin="anonymous"></script>

  <style>
    body{
      font-family:'Inter',sans-serif;
      background:linear-gradient(180deg,#f8fafc,#eef7ff);
      color:#0f172a;
    }
    .glass{
      background:rgba(255,255,255,0.9);
      backdrop-filter:blur(12px);
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.4);
      box-shadow:0 10px 30px rgba(15,23,42,0.12);
    }
    .section-title{
      background:linear-gradient(90deg,#06b6d4,#7c3aed);
      -webkit-background-clip:text;
      color:transparent;
      font-weight:800;
    }
    .sidebar-link{
      display:flex;
      align-items:center;
      gap:10px;
      padding:0.6rem 0.9rem;
      border-radius:999px;
      font-size:0.85rem;
      cursor:pointer;
      color:#e5e7eb;
      transition:.2s;
    }
    .sidebar-link:hover{
      background:rgba(148,163,184,0.2);
    }
    .sidebar-link.active{
      background:linear-gradient(90deg,#06b6d4,#7c3aed);
      color:white;
      box-shadow:0 8px 20px rgba(37,99,235,0.35);
    }
    .status-pill{
      border-radius:999px;
      font-size:0.75rem;
      padding:0.15rem 0.6rem;
    }
    .status-active{
      background:#dcfce7;
      color:#166534;
    }
    .status-paused{
      background:#fef3c7;
      color:#92400e;
    }
    .status-cancelled{
      background:#fee2e2;
      color:#b91c1c;
    }
    .status-expired{
      background:#e5e7eb;
      color:#374151;
    }
  </style>
</head>

<body>

<!-- HEADER -->
<header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b">
  <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
    <a href="index.html" class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-teal-400 text-white flex items-center justify-center font-bold shadow">
        DF
      </div>
      <div>
        <h1 class="text-lg font-semibold">Daily Fruit Co.</h1>
        <p class="text-xs text-gray-500">Freshness Delivered Daily</p>
      </div>
    </a>

    <div class="text-xs text-gray-500 hidden sm:block">
      Logged in as <span id="hdrUserEmail">...</span>
    </div>
  </div>
</header>

<!-- LAYOUT -->
<div class="max-w-6xl mx-auto px-4 py-6 flex gap-5">

  <!-- SIDEBAR -->
  <aside class="w-64 hidden md:block">
    <div class="glass p-4 sticky top-24">
      <div class="mb-4">
        <p class="text-xs text-gray-500 mb-1">Welcome</p>
        <p id="sidebarUserName" class="font-semibold text-slate-800 text-sm">User</p>
      </div>

      <nav class="flex flex-col gap-1 text-xs">
        <button class="sidebar-link active" data-view="dashboard">
          <i class="fa fa-chart-pie"></i> Dashboard Home
        </button>
        <button class="sidebar-link" data-view="plan">
          <i class="fa fa-seedling"></i> My Plan
        </button>
        <button class="sidebar-link" data-view="deliveries">
          <i class="fa fa-truck"></i> Deliveries
        </button>
        <button class="sidebar-link" data-view="payments">
          <i class="fa fa-receipt"></i> Payments
        </button>
        <button class="sidebar-link" data-view="profile">
          <i class="fa fa-user"></i> Profile
        </button>
      </nav>

      <hr class="my-3 border-slate-200">

      <button id="logoutBtn" class="sidebar-link text-red-300">
        <i class="fa fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="flex-1 space-y-4">

    <!-- PAGE TITLE + QUICK ACTIONS -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h2 class="text-2xl md:text-3xl font-extrabold section-title">My Dashboard</h2>
        <p class="text-xs text-gray-500 mt-1">
          Manage your plan, deliveries, payments and profile in one place.
        </p>
      </div>
      <div class="flex flex-wrap gap-2 text-xs">
        <a href="mailto:dailyfruitco@gmail.com"
           class="px-3 py-2 rounded-full text-white"
           style="background:linear-gradient(90deg,#06b6d4,#7c3aed);">
          <i class="fa fa-headset mr-1"></i> Support
        </a>
      </div>
    </div>

    <!-- VIEWS WRAPPER -->
    <div class="space-y-4">

      <!-- DASHBOARD HOME VIEW -->
      <section id="view-dashboard" class="glass p-5 space-y-5">

        <!-- TOP CARDS -->
        <div class="grid md:grid-cols-3 gap-4 text-sm">
          <!-- Active Plan Card -->
          <div class="border rounded-xl p-4 bg-white/80 flex flex-col gap-2">
            <div class="flex justify-between items-center">
              <p class="text-xs text-gray-500">Active Plan</p>
              <span id="dashPlanStatusPill" class="status-pill status-active hidden"></span>
            </div>
            <p id="dashPlanName" class="font-semibold text-slate-800 text-sm">Loading...</p>
            <p id="dashPlanMeta" class="text-xs text-gray-500"></p>
            <button id="goToPlanFromCard"
                    class="mt-2 text-xs text-indigo-600 underline">
              View plan details
            </button>
          </div>

          <!-- Next Delivery Card -->
          <div class="border rounded-xl p-4 bg-white/80 flex flex-col gap-1">
            <p class="text-xs text-gray-500">Next Delivery</p>
            <p id="dashNextDelivery" class="font-semibold text-slate-800 text-sm">Loading...</p>
            <p id="dashNextDeliveryMeta" class="text-xs text-gray-500"></p>
          </div>

          <!-- Payment Summary Card -->
          <div class="border rounded-xl p-4 bg-white/80 flex flex-col gap-1">
            <p class="text-xs text-gray-500">Payments</p>
            <p id="dashLastPayment" class="font-semibold text-slate-800 text-sm">Loading...</p>
            <p id="dashPaymentMeta" class="text-xs text-gray-500"></p>
            <button id="dashViewPaymentsBtn"
                    class="mt-2 text-xs text-indigo-600 underline">
              View payment history
            </button>
          </div>
        </div>

        <!-- MIDDLE: DELIVERY CALENDAR + QUICK ACTIONS -->
        <div class="grid md:grid-cols-3 gap-4">

          <!-- Delivery Calendar -->
          <div class="md:col-span-2 border rounded-xl p-4 bg-white/80 text-sm">
            <div class="flex justify-between items-center mb-2">
              <p class="font-semibold text-slate-800 text-sm">Upcoming Deliveries (7 days)</p>
              <button id="dashViewDeliveriesBtn"
                      class="text-xs text-indigo-600 underline">
                View delivery history
              </button>
            </div>
            <ul id="deliveryCalendarList" class="space-y-1 text-xs text-gray-700">
              <li class="text-gray-400">Loading...</li>
            </ul>
            <p class="mt-2 text-[11px] text-gray-400">
              You can skip a specific delivery from here. Skipped deliveries will not be prepared.
            </p>
          </div>

          <!-- Quick Actions -->
          <div class="border rounded-xl p-4 bg-white/80 text-xs flex flex-col gap-2">
            <p class="font-semibold text-slate-800 mb-1">Quick Actions</p>
            <button id="qaPause" class="w-full border rounded-full px-3 py-1.5 text-left">
              Pause plan
            </button>
            <button id="qaResume" class="w-full border rounded-full px-3 py-1.5 text-left">
              Resume plan
            </button>
            <button id="qaCancel" class="w-full border rounded-full px-3 py-1.5 text-left text-red-600 border-red-300">
              Cancel plan
            </button>
            <button id="qaRenew" class="w-full border rounded-full px-3 py-1.5 text-left">
              Renew same plan
            </button>
            <button id="qaProfile" class="w-full border rounded-full px-3 py-1.5 text-left">
              Edit profile & address
            </button>
          </div>

        </div>

      </section>

      <!-- MY PLAN VIEW -->
      <section id="view-plan" class="glass p-5 space-y-4 hidden text-sm">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold text-slate-800 text-base">My Plan</h3>
            <p class="text-xs text-gray-500">View your active plan and subscription history.</p>
          </div>
        </div>

        <div class="border rounded-xl p-4 bg-white/80 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <p class="text-xs text-gray-500 mb-1">Active Plan</p>
            <p id="planViewName" class="font-semibold text-sm">No active plan</p>
            <p id="planViewMeta" class="text-xs text-gray-500 mt-1"></p>
            <p id="planViewDates" class="text-xs text-gray-500 mt-1"></p>
          </div>
          <div class="flex flex-wrap gap-2 text-xs">
            <button id="planPauseBtn" class="px-3 py-1.5 rounded-full border">
              Pause
            </button>
            <button id="planResumeBtn" class="px-3 py-1.5 rounded-full border">
              Resume
            </button>
            <button id="planCancelBtn" class="px-3 py-1.5 rounded-full border text-red-600 border-red-300">
              Cancel
            </button>
            <button id="planRenewBtn" class="px-3 py-1.5 rounded-full border">
              Renew
            </button>
            <a href="plans.html" class="px-3 py-1.5 rounded-full border">
              Change Plan
            </a>
          </div>
        </div>

        <!-- Subscription history -->
        <div class="border rounded-xl p-4 bg-white/80">
          <div class="flex justify-between items-center mb-2">
            <p class="font-semibold text-sm">Subscription History</p>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-xs">
              <thead>
                <tr class="text-left text-gray-500 border-b">
                  <th class="py-2 pr-4">Plan</th>
                  <th class="py-2 pr-4">Start</th>
                  <th class="py-2 pr-4">End</th>
                  <th class="py-2 pr-4">Status</th>
                </tr>
              </thead>
              <tbody id="subHistoryBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- DELIVERIES VIEW -->
      <section id="view-deliveries" class="glass p-5 space-y-4 hidden text-sm">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold text-slate-800 text-base">Deliveries</h3>
            <p class="text-xs text-gray-500">Upcoming schedule and past deliveries.</p>
          </div>
        </div>

        <div class="border rounded-xl p-4 bg-white/80">
          <p class="font-semibold text-sm mb-2">Upcoming (next 7 days)</p>
          <ul id="delUpcomingList" class="space-y-1 text-xs text-gray-700">
            <li class="text-gray-400">Loading...</li>
          </ul>
        </div>

        <div class="border rounded-xl p-4 bg-white/80">
          <p class="font-semibold text-sm mb-2">Past Deliveries</p>
          <div class="overflow-x-auto">
            <table class="min-w-full text-xs">
              <thead>
                <tr class="text-left text-gray-500 border-b">
                  <th class="py-2 pr-4">Date</th>
                  <th class="py-2 pr-4">Status</th>
                  <th class="py-2 pr-4">Notes</th>
                </tr>
              </thead>
              <tbody id="deliveryHistoryBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PAYMENTS VIEW -->
      <section id="view-payments" class="glass p-5 space-y-4 hidden text-sm">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold text-slate-800 text-base">Payments</h3>
            <p class="text-xs text-gray-500">All your payments and invoices.</p>
          </div>
          <button id="downloadLastInvoiceBtn"
                  class="px-3 py-1.5 rounded-full border text-xs">
            Download last invoice
          </button>
        </div>

        <div class="border rounded-xl p-4 bg-white/80">
          <div class="overflow-x-auto">
            <table class="min-w-full text-xs">
              <thead>
                <tr class="text-left text-gray-500 border-b">
                  <th class="py-2 pr-4">Date</th>
                  <th class="py-2 pr-4">Plan</th>
                  <th class="py-2 pr-4">Amount</th>
                  <th class="py-2 pr-4">Method</th>
                  <th class="py-2 pr-4">Status</th>
                </tr>
              </thead>
              <tbody id="paymentHistoryBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PROFILE VIEW -->
      <section id="view-profile" class="glass p-5 space-y-4 hidden text-sm">
        <div>
          <h3 class="font-semibold text-slate-800 text-base">Profile & Address</h3>
          <p class="text-xs text-gray-500">Update your basic details and delivery address.</p>
        </div>

        <form id="profileForm" class="space-y-4">
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-semibold text-gray-700 mb-1">Full Name *</label>
              <input type="text" id="pfFullName" required
                     class="w-full px-3 py-2 border rounded-md bg-white/80">
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-700 mb-1">Email *</label>
              <input type="email" id="pfEmail" required disabled
                     class="w-full px-3 py-2 border rounded-md bg-gray-100 text-gray-500">
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-semibold text-gray-700 mb-1">Phone (WhatsApp) *</label>
              <input type="tel" id="pfPhone" required
                     class="w-full px-3 py-2 border rounded-md bg-white/80">
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-700 mb-1">User Type</label>
              <select id="pfUserType"
                      class="w-full px-3 py-2 border rounded-md bg-white/80">
                <option value="">Customer</option>
                <option value="home">Home</option>
                <option value="office">Office</option>
                <option value="corporate">Corporate</option>
              </select>
            </div>
          </div>

          <div class="border-t pt-3">
            <p class="text-xs font-semibold text-gray-700 mb-2">Primary Delivery Address</p>

            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">House / Flat *</label>
                <input type="text" id="pfHouse" required
                       class="w-full px-3 py-2 border rounded-md bg-white/80">
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Street *</label>
                <input type="text" id="pfStreet" required
                       class="w-full px-3 py-2 border rounded-md bg-white/80">
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4 mt-3">
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Area *</label>
                <input type="text" id="pfArea" required
                       class="w-full px-3 py-2 border rounded-md bg-white/80">
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">City *</label>
                <input type="text" id="pfCity" required
                       class="w-full px-3 py-2 border rounded-md bg-white/80">
              </div>
            </div>

            <div class="mt-3 max-w-xs">
              <label class="block text-xs font-medium text-gray-600 mb-1">Pincode *</label>
              <input type="text" id="pfPincode" required
                     class="w-full px-3 py-2 border rounded-md bg-white/80">
            </div>
          </div>

          <div class="border-t pt-3 space-y-2">
            <div>
              <p class="text-xs font-semibold text-gray-700 mb-1">Preferred Delivery Time</p>
              <select id="pfDeliveryTime" class="w-full md:w-60 px-3 py-2 border rounded-md bg-white/80 text-sm">
                <option value="">Select time</option>
                <option value="morning">Morning (6:30 AM – 9:00 AM)</option>
                <option value="afternoon">Afternoon</option>
                <option value="evening">Evening</option>
              </select>
            </div>

            <label class="flex items-center gap-2 text-xs text-gray-700">
              <input type="checkbox" id="pfOffersOptIn">
              <span>Receive deals & updates on WhatsApp / Email</span>
            </label>
          </div>

          <div class="pt-2">
            <button type="submit"
                    class="px-6 py-2.5 rounded-full text-white text-sm font-semibold"
                    style="background:linear-gradient(90deg,#06b6d4,#7c3aed);">
              Save Profile
            </button>
          </div>
        </form>
      </section>

    </div>

  </main>
</div>

<!-- Footer (simple) -->
<footer class="mt-8 pb-6 text-center text-[11px] text-gray-400">
  © 2025 Daily Fruit Co. — Freshness Delivered Daily
</footer>

<script>
const API_BASE = 'https://dailyfruit-backend.onrender.com';

function toast(msg, isError){
  const el = document.createElement('div');
  el.textContent = msg;
  el.className =
    'fixed right-4 bottom-4 z-50 text-sm px-3 py-2 rounded shadow text-white ' +
    (isError ? 'bg-red-600' : 'bg-black');
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),3000);
}

function getSession(){
  try{
    const token = localStorage.getItem('df_user_token');
    const expiry = parseInt(localStorage.getItem('df_session_expiry') || '0',10);
    if(!token || !expiry) return null;
    if(Date.now() > expiry) return null;
    return { token, expiry };
  }catch(e){
    return null;
  }
}

function clearSessionAndGoLogin(message){
  localStorage.removeItem('df_user_token');
  localStorage.removeItem('df_session_expiry');
  localStorage.removeItem('df_user_profile');
  if(message) toast(message,true);
  setTimeout(()=>{ window.location.href='login.html'; },800);
}

/* -------------- GLOBAL STATE ------------- */
let gProfile = null;
let gActiveSub = null;
let gSubHistory = [];
let gPaymentHistory = [];
let gUpcomingDeliveries = [];
let gDeliveryHistory = [];

/* -------------- INIT ------------- */
document.addEventListener('DOMContentLoaded', () => {
  const session = getSession();
  if(!session){
    clearSessionAndGoLogin('Session expired, please login again.');
    return;
  }
  const token = session.token;

  initSidebar();
  initLogout();
  initProfileForm();
  initQuickActions();

  loadAllData(token);
});

/* -------------- SIDEBAR NAV ------------- */
function showView(view){
  document.querySelectorAll('[id^="view-"]').forEach(sec => sec.classList.add('hidden'));
  document.getElementById('view-' + view).classList.remove('hidden');

  document.querySelectorAll('.sidebar-link').forEach(btn => {
    if(btn.dataset.view === view) btn.classList.add('active');
    else btn.classList.remove('active');
  });
}

function initSidebar(){
  document.querySelectorAll('.sidebar-link[data-view]').forEach(btn=>{
    btn.addEventListener('click',()=> showView(btn.dataset.view));
  });

  document.getElementById('goToPlanFromCard').onclick = () => showView('plan');
  document.getElementById('dashViewDeliveriesBtn').onclick = () => showView('deliveries');
  document.getElementById('dashViewPaymentsBtn').onclick = () => showView('payments');
  document.getElementById('qaProfile').onclick = () => showView('profile');
}

/* -------------- LOGOUT ------------- */
function initLogout(){
  const btn = document.getElementById('logoutBtn');
  if(btn){
    btn.addEventListener('click',()=>{
      if(!confirm('Logout from your account?')) return;
      clearSessionAndGoLogin();
    });
  }
}

/* -------------- LOAD ALL DATA ------------- */
async function loadAllData(token){
  try{
    await Promise.all([
      loadProfile(token),
      loadSubscription(token),
      loadSubscriptionHistory(token),
      loadPayments(token),
      loadUpcomingDeliveries(token),
      loadDeliveryHistory(token)
    ]);

    renderHeaderAndSidebar();
    renderDashboardCards();
    renderPlanView();
    renderSubHistoryTable();
    renderPaymentsTable();
    renderDeliveryCalendar();
    renderDeliveriesView();
    fillProfileForm();
  }catch(err){
    console.error(err);
    toast('Error loading dashboard', true);
  }
}

/* -------------- PROFILE ------------- */
async function loadProfile(token){
  try{
    const res = await fetch(API_BASE + '/api/profile/me', {
      headers:{ 'Authorization':'Bearer ' + token }
    });
    if(res.status === 401 || res.status === 403){
      return clearSessionAndGoLogin('Please login again.');
    }
    if(!res.ok) return;
    const user = await res.json();
    gProfile = {
      id: user._id,
      fullName: user.name || '',
      email: user.email || '',
      phone: user.phone || '',
      userType: user.userType || '',
      address: {
        house: user.addressDetails?.house || '',
        street: user.addressDetails?.street || '',
        area: user.addressDetails?.area || '',
        city: user.addressDetails?.city || '',
        pincode: user.addressDetails?.pincode || ''
      },
      deliveryTime: user.deliveryTime || '',
      offersOptIn: !!user.offersOptIn
    };
    localStorage.setItem('df_user_profile', JSON.stringify(gProfile));
  }catch(e){
    console.warn('Profile load error', e);
  }

  if(!gProfile){
    const raw = localStorage.getItem('df_user_profile');
    if(raw) gProfile = JSON.parse(raw);
  }

  if(!gProfile){
    clearSessionAndGoLogin('Profile not found, please login again.');
  }
}

/* -------------- SUBSCRIPTIONS ------------- */
async function loadSubscription(token){
  try{
    const res = await fetch(API_BASE + '/api/subscriptions/my-active', {
      headers:{ 'Authorization':'Bearer ' + token }
    });
    if(res.ok){
      gActiveSub = await res.json();
    }
  }catch(e){
    console.warn('Active sub error', e);
  }
}

async function loadSubscriptionHistory(token){
  try{
    const res = await fetch(API_BASE + '/api/subscriptions/me', {
      headers:{ 'Authorization':'Bearer ' + token }
    });
    if(res.ok){
      gSubHistory = await res.json();
    }
  }catch(e){
    console.warn('Sub history error', e);
  }
}

/* -------------- PAYMENTS ------------- */
async function loadPayments(token){
  try{
    const res = await fetch(API_BASE + '/api/payments/my-payments', {
      headers:{ 'Authorization':'Bearer ' + token }
    });
    if(res.ok){
      gPaymentHistory = await res.json();
    }
  }catch(e){
    console.warn('payment history error', e);
  }
}

/* -------------- DELIVERIES ------------- */
async function loadUpcomingDeliveries(token){
  try{
    const res = await fetch(API_BASE + '/api/deliveries/upcoming', {
      headers:{ 'Authorization':'Bearer ' + token }
    });
    if(res.ok){
      gUpcomingDeliveries = await res.json();
    }
  }catch(e){
    console.warn('upcoming deliveries error', e);
  }
}

async function loadDeliveryHistory(token){
  try{
    const res = await fetch(API_BASE + '/api/deliveries/history', {
      headers:{ 'Authorization':'Bearer ' + token }
    });
    if(res.ok){
      gDeliveryHistory = await res.json();
    }
  }catch(e){
    console.warn('delivery history error', e);
  }
}

/* -------------- RENDER HEADER + SIDEBAR ------------- */
function renderHeaderAndSidebar(){
  if(gProfile){
    const name = gProfile.fullName || 'User';
    const email = gProfile.email || '-';
    const hdrEmail = document.getElementById('hdrUserEmail');
    const sbName = document.getElementById('sidebarUserName');
    if(hdrEmail) hdrEmail.textContent = email;
    if(sbName) sbName.textContent = name;
  }
}

/* -------------- DASHBOARD HOME RENDER ------------- */
function renderDashboardCards(){
  const planNameEl = document.getElementById('dashPlanName');
  const planMetaEl = document.getElementById('dashPlanMeta');
  const statusPill = document.getElementById('dashPlanStatusPill');
  const nextDelEl = document.getElementById('dashNextDelivery');
  const nextDelMetaEl = document.getElementById('dashNextDeliveryMeta');
  const lastPayEl = document.getElementById('dashLastPayment');
  const payMetaEl = document.getElementById('dashPaymentMeta');

  // Plan
  if(gActiveSub && gActiveSub._id){
    const pName = gActiveSub.planName || (gActiveSub.planId && gActiveSub.planId.name) || 'Active Plan';
    const price = gActiveSub.planId && gActiveSub.planId.price;
    const status = gActiveSub.status || 'active';

    if(planNameEl) planNameEl.textContent = pName;
    if(planMetaEl){
      planMetaEl.textContent = price ? `₹${price} • ${status}` : `Status: ${status}`;
    }

    let pillText = status;
    let pillClass = 'status-pill ';
    if(status === 'active') pillClass += 'status-active';
    else if(status === 'paused') pillClass += 'status-paused';
    else if(status === 'cancelled') pillClass += 'status-cancelled';
    else pillClass += 'status-expired';

    statusPill.textContent = pillText;
    statusPill.className = pillClass;
    statusPill.classList.remove('hidden');
  }else{
    if(planNameEl) planNameEl.textContent = 'No active plan';
    if(planMetaEl) planMetaEl.textContent = 'You can start a subscription from the Plans page.';
    statusPill.classList.add('hidden');
  }

  // Next Delivery
  if(gUpcomingDeliveries && gUpcomingDeliveries.length > 0){
    const first = gUpcomingDeliveries[0];
    const d = new Date(first.deliveryDate);
    if(nextDelEl) nextDelEl.textContent = d.toDateString();
    if(nextDelMetaEl) nextDelMetaEl.textContent = `Status: ${first.status || 'scheduled'}`;
  }else{
    if(nextDelEl) nextDelEl.textContent = 'No upcoming delivery';
    if(nextDelMetaEl) nextDelMetaEl.textContent = '';
  }

  // Payment summary
  if(gPaymentHistory && gPaymentHistory.length > 0){
    const last = gPaymentHistory[0];
    const dt = last.createdAt ? new Date(last.createdAt).toLocaleDateString('en-IN') : '-';
    const amt = typeof last.amount === 'number' ? '₹' + last.amount : '-';
    if(lastPayEl) lastPayEl.textContent = `${amt} on ${dt}`;
    if(payMetaEl) payMetaEl.textContent = last.planName ? `Last paid for ${last.planName}` : '';
  }else{
    if(lastPayEl) lastPayEl.textContent = 'No payments yet';
    if(payMetaEl) payMetaEl.textContent = '';
  }
}

/* -------------- DELIVERY CALENDAR (HOME) ------------- */
function renderDeliveryCalendar(){
  const calEl = document.getElementById('deliveryCalendarList');
  if(!calEl) return;
  calEl.innerHTML = '';

  if(!gUpcomingDeliveries || gUpcomingDeliveries.length === 0){
    calEl.innerHTML = '<li class="text-gray-400 text-xs">No deliveries scheduled.</li>';
    return;
  }

  gUpcomingDeliveries.forEach(del => {
    const d = new Date(del.deliveryDate);
    const li = document.createElement('li');
    li.className = 'flex justify-between items-center py-1';
    li.innerHTML = `
      <span>${d.toDateString()} • <span class="capitalize">${del.status}</span></span>
      <button class="text-red-500 text-[11px]" onclick="skipDelivery('${del._id}')">
        Skip
      </button>
    `;
    calEl.appendChild(li);
  });
}

/* -------------- DELIVERIES VIEW RENDER ------------- */
function renderDeliveriesView(){
  const upEl = document.getElementById('delUpcomingList');
  const histBody = document.getElementById('deliveryHistoryBody');

  // Upcoming
  if(upEl){
    upEl.innerHTML = '';
    if(!gUpcomingDeliveries || gUpcomingDeliveries.length === 0){
      upEl.innerHTML = '<li class="text-gray-400 text-xs">No upcoming deliveries.</li>';
    }else{
      gUpcomingDeliveries.forEach(del=>{
        const d = new Date(del.deliveryDate);
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center py-1';
        li.innerHTML = `
          <span>${d.toDateString()} • <span class="capitalize">${del.status}</span></span>
          <button class="text-red-500 text-[11px]" onclick="skipDelivery('${del._id}')">Skip</button>
        `;
        upEl.appendChild(li);
      });
    }
  }

  // History
  if(histBody){
    histBody.innerHTML = '';
    if(!gDeliveryHistory || gDeliveryHistory.length === 0){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 3;
      td.className = 'py-2 text-gray-400';
      td.textContent = 'No past deliveries found.';
      tr.appendChild(td);
      histBody.appendChild(tr);
    }else{
      gDeliveryHistory.forEach(d=>{
        const dt = d.deliveryDate ? new Date(d.deliveryDate).toLocaleDateString('en-IN') : '-';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 pr-4">${dt}</td>
          <td class="py-2 pr-4 capitalize">${d.status || '-'}</td>
          <td class="py-2 pr-4">${d.notes || '-'}</td>
        `;
        histBody.appendChild(tr);
      });
    }
  }
}

/* -------------- PLAN VIEW RENDER ------------- */
function renderPlanView(){
  const nameEl = document.getElementById('planViewName');
  const metaEl = document.getElementById('planViewMeta');
  const datesEl = document.getElementById('planViewDates');

  if(!gActiveSub || !gActiveSub._id){
    if(nameEl) nameEl.textContent = 'No active plan';
    if(metaEl) metaEl.textContent = 'You can start a plan from the Plans page.';
    if(datesEl) datesEl.textContent = '';
    return;
  }

  const pName = gActiveSub.planName || (gActiveSub.planId && gActiveSub.planId.name) || 'Active Plan';
  const price = gActiveSub.planId && gActiveSub.planId.price;
  const status = gActiveSub.status || 'active';

  const start = gActiveSub.startDate ? new Date(gActiveSub.startDate).toLocaleDateString('en-IN') : '-';
  const end = gActiveSub.endDate ? new Date(gActiveSub.endDate).toLocaleDateString('en-IN') : '-';

  if(nameEl) nameEl.textContent = pName;
  if(metaEl) metaEl.textContent = price ? `₹${price} • Status: ${status}` : `Status: ${status}`;
  if(datesEl) datesEl.textContent = `From ${start} to ${end}`;
}

/* -------------- SUB HISTORY RENDER ------------- */
function renderSubHistoryTable(){
  const body = document.getElementById('subHistoryBody');
  if(!body) return;
  body.innerHTML = '';

  if(!gSubHistory || gSubHistory.length === 0){
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 4;
    td.className = 'py-2 text-gray-400';
    td.textContent = 'No subscriptions found.';
    tr.appendChild(td);
    body.appendChild(tr);
    return;
  }

  gSubHistory.forEach(sub=>{
    const name = sub.planName || (sub.planId && sub.planId.name) || '-';
    const start = sub.startDate ? new Date(sub.startDate).toLocaleDateString('en-IN') : '-';
    const end = sub.endDate ? new Date(sub.endDate).toLocaleDateString('en-IN') : '-';
    const status = sub.status || '-';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="py-2 pr-4">${name}</td>
      <td class="py-2 pr-4">${start}</td>
      <td class="py-2 pr-4">${end}</td>
      <td class="py-2 pr-4 capitalize">${status}</td>
    `;
    body.appendChild(tr);
  });
}

/* -------------- PAYMENTS TABLE RENDER ------------- */
function renderPaymentsTable(){
  const body = document.getElementById('paymentHistoryBody');
  if(!body) return;
  body.innerHTML = '';

  if(!gPaymentHistory || gPaymentHistory.length === 0){
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 5;
    td.className = 'py-2 text-gray-400';
    td.textContent = 'No payments yet.';
    tr.appendChild(td);
    body.appendChild(tr);
    return;
  }

  gPaymentHistory.forEach(pay=>{
    const date = pay.createdAt ? new Date(pay.createdAt).toLocaleDateString('en-IN') : '-';
    const planName = pay.planName || '-';
    const amount = typeof pay.amount === 'number' ? '₹' + pay.amount : '-';
    const method = pay.razorpayPaymentId ? 'Razorpay' : (pay.isOffline ? 'Offline' : 'Other');
    const status = pay.status || '-';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="py-2 pr-4">${date}</td>
      <td class="py-2 pr-4">${planName}</td>
      <td class="py-2 pr-4">${amount}</td>
      <td class="py-2 pr-4">${method}</td>
      <td class="py-2 pr-4 capitalize">${status}</td>
    `;
    body.appendChild(tr);
  });
}

/* -------------- SKIP DELIVERY (GLOBAL) ------------- */
async function skipDelivery(id){
  const session = getSession();
  if(!session){
    return clearSessionAndGoLogin('Session expired, please login again.');
  }
  try{
    const res = await fetch(API_BASE + '/api/deliveries/skip/' + id, {
      method:'POST',
      headers:{ 'Authorization':'Bearer ' + session.token }
    });
    const data = await res.json();
    if(!res.ok){
      toast(data.message || 'Error skipping delivery', true);
      return;
    }
    toast('Delivery skipped.', false);
    await loadUpcomingDeliveries(session.token);
    await loadDeliveryHistory(session.token);
    renderDeliveryCalendar();
    renderDeliveriesView();
  }catch(err){
    console.error(err);
    toast('Network error while skipping.', true);
  }
}
window.skipDelivery = skipDelivery;

/* -------------- QUICK ACTIONS (PAUSE / RESUME / CANCEL / RENEW) ------------- */
function initQuickActions(){
  const session = getSession();
  if(!session) return;

  const token = session.token;
  const pauseButtons = [document.getElementById('qaPause'), document.getElementById('planPauseBtn')];
  const resumeButtons = [document.getElementById('qaResume'), document.getElementById('planResumeBtn')];
  const cancelButtons = [document.getElementById('qaCancel'), document.getElementById('planCancelBtn')];
  const renewButtons = [document.getElementById('qaRenew'), document.getElementById('planRenewBtn')];

  pauseButtons.forEach(btn=>{
    if(btn){
      btn.addEventListener('click',()=> subAction('pause', token));
    }
  });
  resumeButtons.forEach(btn=>{
    if(btn){
      btn.addEventListener('click',()=> subAction('resume', token));
    }
  });
  cancelButtons.forEach(btn=>{
    if(btn){
      btn.addEventListener('click',()=> subAction('cancel', token));
    }
  });
  renewButtons.forEach(btn=>{
    if(btn){
      btn.addEventListener('click',()=> subAction('renew', token));
    }
  });

  const downloadBtn = document.getElementById('downloadLastInvoiceBtn');
  if(downloadBtn){
    downloadBtn.addEventListener('click', ()=> downloadLastInvoice(token));
  }
}

async function subAction(action, token){
  if(!gActiveSub || !gActiveSub._id){
    toast('No active subscription found.', true);
    return;
  }

  if(action === 'cancel' && !confirm('Are you sure you want to cancel your subscription?')) return;

  try{
    const res = await fetch(API_BASE + '/api/subscriptions/' + gActiveSub._id + '/' + action, {
      method:'POST',
      headers:{ 'Authorization':'Bearer ' + token }
    });
    const data = await res.json();
    if(!res.ok){
      toast(data.message || 'Error updating subscription', true);
      return;
    }
    toast(data.message || 'Updated.', false);

    await loadSubscription(token);
    await loadSubscriptionHistory(token);
    await loadUpcomingDeliveries(token);
    await loadDeliveryHistory(token);

    renderDashboardCards();
    renderPlanView();
    renderSubHistoryTable();
    renderDeliveryCalendar();
    renderDeliveriesView();

  }catch(err){
    console.error(err);
    toast('Network error updating subscription.', true);
  }
}

/* -------------- DOWNLOAD LAST INVOICE ------------- */
async function downloadLastInvoice(token){
  try{
    const res = await fetch(API_BASE + '/api/payments/latest-invoice', {
      headers:{ 'Authorization':'Bearer ' + token }
    });
    const data = await res.json();
    if(!res.ok || !data){
      toast(data?.message || 'No invoice found.', true);
      return;
    }

    let url = data.invoiceUrl || data.pdfUrl || data.url;
    if(!url && data.invoice && (data.invoice.pdfUrl || data.invoice.pdfPath)){
      url = data.invoice.pdfUrl || data.invoice.pdfPath;
    }
    if(!url){
      toast('Invoice URL not returned by backend.', true);
      return;
    }
    if(url.startsWith('/')){
      url = API_BASE + url;
    }
    window.open(url, '_blank');
  }catch(err){
    console.error(err);
    toast('Error fetching invoice.', true);
  }
}

/* -------------- PROFILE FORM ------------- */
function initProfileForm(){
  const form = document.getElementById('profileForm');
  if(!form) return;
  form.addEventListener('submit', onProfileSubmit);
}

function fillProfileForm(){
  if(!gProfile) return;
  document.getElementById('pfFullName').value   = gProfile.fullName || '';
  document.getElementById('pfEmail').value      = gProfile.email || '';
  document.getElementById('pfPhone').value      = gProfile.phone || '';
  document.getElementById('pfUserType').value   = gProfile.userType || '';

  document.getElementById('pfHouse').value      = gProfile.address?.house || '';
  document.getElementById('pfStreet').value     = gProfile.address?.street || '';
  document.getElementById('pfArea').value       = gProfile.address?.area || '';
  document.getElementById('pfCity').value       = gProfile.address?.city || '';
  document.getElementById('pfPincode').value    = gProfile.address?.pincode || '';

  document.getElementById('pfDeliveryTime').value = gProfile.deliveryTime || '';
  document.getElementById('pfOffersOptIn').checked = !!gProfile.offersOptIn;
}

async function onProfileSubmit(e){
  e.preventDefault();
  const session = getSession();
  if(!session){
    return clearSessionAndGoLogin('Session expired, please login again.');
  }

  const fullName = document.getElementById('pfFullName').value.trim();
  const email    = document.getElementById('pfEmail').value.trim();
  const phone    = document.getElementById('pfPhone').value.trim();
  const userType = document.getElementById('pfUserType').value;

  const house    = document.getElementById('pfHouse').value.trim();
  const street   = document.getElementById('pfStreet').value.trim();
  const area     = document.getElementById('pfArea').value.trim();
  const city     = document.getElementById('pfCity').value.trim();
  const pincode  = document.getElementById('pfPincode').value.trim();

  const deliveryTime = document.getElementById('pfDeliveryTime').value;
  const offersOptIn  = document.getElementById('pfOffersOptIn').checked;

  if(phone.length !== 10 || !/^[0-9]{10}$/.test(phone)){
    toast('Please enter a valid 10-digit phone.', true);
    return;
  }
  if(!/^[0-9]{6}$/.test(pincode)){
    toast('Please enter a valid 6-digit pincode.', true);
    return;
  }

  const addressDetails = { house, street, area, city, pincode };
  const address = `${house}, ${street}, ${area}, ${city} - ${pincode}`;

  const payload = {
    fullName,
    phone,
    addressDetails,
    address,
    userType,
    offersOptIn,
    deliveryTime
  };

  try{
    const res = await fetch(API_BASE + '/api/profile/update', {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization':'Bearer ' + session.token
      },
      body:JSON.stringify(payload)
    });

    const d = await res.json().catch(()=> ({}));
    if(!res.ok){
      toast(d.message || 'Error updating profile.', true);
      return;
    }

    const user = d.user || {};
    gProfile = {
      id: user._id || gProfile.id,
      fullName: user.name || fullName,
      email: user.email || email,
      phone: user.phone || phone,
      userType: user.userType || userType,
      address: {
        house: user.addressDetails?.house || house,
        street: user.addressDetails?.street || street,
        area: user.addressDetails?.area || area,
        city: user.addressDetails?.city || city,
        pincode: user.addressDetails?.pincode || pincode
      },
      deliveryTime: user.deliveryTime || deliveryTime,
      offersOptIn: typeof user.offersOptIn === 'boolean' ? user.offersOptIn : offersOptIn
    };

    localStorage.setItem('df_user_profile', JSON.stringify(gProfile));
    renderHeaderAndSidebar();
    toast('Profile updated.', false);
  }catch(err){
    console.error(err);
    toast('Network error updating profile.', true);
  }
}
</script>

</body>
</html>
