<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard — Daily Fruit Co.</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <!-- Icons -->
  <script src="https://kit.fontawesome.com/0c9b1f3f2d.js" crossorigin="anonymous"></script>

  <style>
    body{
      font-family:'Inter',sans-serif;
      background:linear-gradient(180deg,#f8fafc,#eef7ff);
      color:#0f172a;
    }
    .glass{
      background:rgba(255,255,255,0.9);
      backdrop-filter:blur(12px);
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.4);
      box-shadow:0 10px 30px rgba(15,23,42,0.12);
    }
    .section-title{
      background:linear-gradient(90deg,#06b6d4,#7c3aed);
      -webkit-background-clip:text;
      color:transparent;
      font-weight:800;
    }
    .sidebar-link{
      display:flex;
      align-items:center;
      gap:10px;
      padding:0.6rem 0.9rem;
      border-radius:999px;
      font-size:0.85rem;
      cursor:pointer;
      color:#e5e7eb;
      transition:.2s;
    }
    .sidebar-link:hover{
      background:rgba(148,163,184,0.2);
    }
    .sidebar-link.active{
      background:linear-gradient(90deg,#06b6d4,#7c3aed);
      color:white;
      box-shadow:0 8px 20px rgba(37,99,235,0.35);
    }
    .status-pill{
      border-radius:999px;
      font-size:0.75rem;
      padding:0.15rem 0.6rem;
    }
    .status-active{
      background:#dcfce7;
      color:#166534;
    }
    .status-paused{
      background:#fef3c7;
      color:#92400e;
    }
    .status-cancelled{
      background:#fee2e2;
      color:#b91c1c;
    }
    .status-expired{
      background:#e5e7eb;
      color:#374151;
    }

    /* Desktop sidebar collapse / expand */
    @media (min-width:768px){
      .sidebar-shell{
        transition:width .2s;
      }
      .sidebar-expanded{
        width:15rem;
      }
      .sidebar-collapsed{
        width:4rem;
      }
      .sidebar-collapsed .sidebar-text{
        display:none;
      }
      .sidebar-collapsed .sidebar-link{
        justify-content:center;
      }
      .sidebar-collapsed .welcome-block{
        display:none;
      }
    }

    /* Mobile sidebar overlay */
    #mobileSidebarOverlay{
      background:rgba(15,23,42,0.45);
    }
  </style>
</head>

<body>

<!-- HEADER -->
<header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b">
  <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">

    <div class="flex items-center gap-2">
      <!-- Mobile menu button -->
      <button id="mobileMenuBtn" class="md:hidden mr-1 text-slate-600">
        <i class="fa fa-bars text-lg"></i>
      </button>

      <!-- Brand -->
      <a href="index.html" class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-teal-400 text-white flex items-center justify-center font-bold shadow">
          DF
        </div>
        <div class="hidden sm:block">
          <h1 class="text-lg font-semibold">Daily Fruit Co.</h1>
          <p class="text-xs text-gray-500">Freshness Delivered Daily</p>
        </div>
      </a>
    </div>

    <!-- Right: Welcome + profile icon -->
    <div class="flex items-center gap-4">
      <div class="hidden sm:flex flex-col items-end leading-tight">
        <span class="text-[11px] text-gray-400">Welcome back</span>
        <span id="hdrUserName" class="text-xs font-semibold text-slate-800">Customer</span>
      </div>

      <div class="relative">
        <button id="profileMenuBtn"
                class="w-9 h-9 flex items-center justify-center rounded-full bg-slate-100 border border-slate-200 hover:bg-slate-200">
          <i class="fa-solid fa-user text-slate-600 text-sm"></i>
        </button>

        <!-- Profile dropdown -->
        <div id="profileMenu"
             class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg border border-slate-100 text-xs py-1 z-50">
          <div class="px-3 py-2 border-b text-[11px] text-gray-500">
            <div id="menuUserName" class="font-semibold text-slate-700 text-xs">Customer</div>
            <div id="menuUserEmail" class="">email@example.com</div>
          </div>
          <button id="menuProfileBtn"
                  class="w-full text-left px-3 py-2 hover:bg-slate-50">
            <i class="fa fa-user mr-2"></i> Profile
          </button>
          <button id="menuPaymentsBtn"
                  class="w-full text-left px-3 py-2 hover:bg-slate-50">
            <i class="fa fa-receipt mr-2"></i> Payments
          </button>
          <button id="menuLogoutBtn"
                  class="w-full text-left px-3 py-2 hover:bg-slate-50 text-red-500">
            <i class="fa fa-sign-out-alt mr-2"></i> Logout
          </button>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- MOBILE SIDEBAR -->
<div id="mobileSidebarOverlay" class="fixed inset-0 z-40 hidden md:hidden">
  <div class="absolute inset-0"></div>
  <div class="relative h-full w-72 max-w-full bg-slate-950 text-slate-100 shadow-xl p-4 flex flex-col">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-2">
        <div class="w-9 h-9 rounded-full bg-gradient-to-br from-green-400 to-teal-400 text-white flex items-center justify-center font-bold shadow">
          DF
        </div>
        <div>
          <p class="text-xs text-gray-400">Welcome</p>
          <p id="mobileSidebarUserName" class="font-semibold text-sm">User</p>
        </div>
      </div>
      <button data-close-mobile class="text-slate-300">
        <i class="fa fa-times text-lg"></i>
      </button>
    </div>

    <nav class="flex-1 flex flex-col gap-1 text-xs">
      <button class="sidebar-link active" data-view="dashboard" data-close-mobile>
        <i class="fa fa-chart-pie"></i>
        <span class="sidebar-text">Dashboard Home</span>
      </button>

      <!-- New Home link -->
      <a href="index.html" class="sidebar-link" data-close-mobile>
        <i class="fa fa-home"></i>
        <span class="sidebar-text">Home</span>
      </a>

      <button class="sidebar-link" data-view="plans" data-close-mobile>
        <i class="fa fa-list"></i>
        <span class="sidebar-text">View Plans</span>
      </button>
      <button class="sidebar-link" data-view="plans" data-close-mobile>
        <i class="fa fa-sync-alt"></i>
        <span class="sidebar-text">Change Plan</span>
      </button>
      <button class="sidebar-link" data-view="plans" data-close-mobile>
        <i class="fa fa-box-open"></i>
        <span class="sidebar-text">Subscription Plans</span>
      </button>
      <button class="sidebar-link" data-view="plan" data-close-mobile>
        <i class="fa fa-seedling"></i>
        <span class="sidebar-text">My Plan</span>
      </button>
      <button class="sidebar-link" data-view="deliveries" data-close-mobile>
        <i class="fa fa-truck"></i>
        <span class="sidebar-text">Deliveries</span>
      </button>
      <button class="sidebar-link" data-view="payments" data-close-mobile>
        <i class="fa fa-receipt"></i>
        <span class="sidebar-text">Payments</span>
      </button>
      <button class="sidebar-link" data-view="profile" data-close-mobile>
        <i class="fa fa-user"></i>
        <span class="sidebar-text">Profile</span>
      </button>
    </nav>

    <button id="mobileLogoutBtn" class="sidebar-link text-red-300 mt-2" data-close-mobile>
      <i class="fa fa-sign-out-alt"></i>
      <span class="sidebar-text">Logout</span>
    </button>
  </div>
</div>

<!-- LAYOUT -->
<div class="max-w-6xl mx-auto px-4 py-6 flex gap-5">

  <!-- SIDEBAR DESKTOP -->
  <aside id="desktopSidebar" class="hidden md:block sidebar-shell sidebar-collapsed">
    <div class="glass p-4 sticky top-24 flex flex-col h-full bg-slate-950 text-slate-100">
      <div class="welcome-block mb-4">
        <p class="text-xs text-gray-400 mb-1">Welcome</p>
        <p id="sidebarUserName" class="font-semibold text-slate-50 text-sm">User</p>
      </div>

      <nav class="flex flex-col gap-1 text-xs">
        <button class="sidebar-link active" data-view="dashboard">
          <i class="fa fa-chart-pie"></i>
          <span class="sidebar-text">Dashboard Home</span>
        </button>

        <!-- New Home link -->
        <a href="index.html" class="sidebar-link">
          <i class="fa fa-home"></i>
          <span class="sidebar-text">Home</span>
        </a>

        <!-- View Plans / Change Plan / Subscription Plans all open same iframe -->
        <button class="sidebar-link" data-view="plans">
          <i class="fa fa-list"></i>
          <span class="sidebar-text">View Plans</span>
        </button>
        <button class="sidebar-link" data-view="plans">
          <i class="fa fa-sync-alt"></i>
          <span class="sidebar-text">Change Plan</span>
        </button>
        <button class="sidebar-link" data-view="plans">
          <i class="fa fa-box-open"></i>
          <span class="sidebar-text">Subscription Plans</span>
        </button>

        <button class="sidebar-link" data-view="plan">
          <i class="fa fa-seedling"></i>
          <span class="sidebar-text">My Plan</span>
        </button>
        <button class="sidebar-link" data-view="deliveries">
          <i class="fa fa-truck"></i>
          <span class="sidebar-text">Deliveries</span>
        </button>
        <button class="sidebar-link" data-view="payments">
          <i class="fa fa-receipt"></i>
          <span class="sidebar-text">Payments</span>
        </button>
        <button class="sidebar-link" data-view="profile">
          <i class="fa fa-user"></i>
          <span class="sidebar-text">Profile</span>
        </button>
      </nav>

      <hr class="my-3 border-slate-600">

      <button id="logoutBtn" class="sidebar-link text-red-300 mt-auto">
        <i class="fa fa-sign-out-alt"></i>
        <span class="sidebar-text">Logout</span>
      </button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="flex-1 space-y-4">

    <!-- PAGE TITLE + QUICK ACTIONS -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h2 class="text-2xl md:text-3xl font-extrabold section-title">My Dashboard</h2>
        <p class="text-xs text-gray-500 mt-1">
          Manage your plan, deliveries, payments and profile in one place.
        </p>
      </div>
      <div class="flex flex-wrap gap-2 text-xs">
        <a href="mailto:dailyfruitco@gmail.com"
           class="px-3 py-2 rounded-full text-white"
           style="background:linear-gradient(90deg,#06b6d4,#7c3aed);">
          <i class="fa fa-headset mr-1"></i> Support
        </a>
      </div>
    </div>

    <!-- VIEWS WRAPPER -->
    <div class="space-y-4">

      <!-- DASHBOARD HOME VIEW -->
      <section id="view-dashboard" class="glass p-5 space-y-5">

        <!-- TOP CARDS -->
        <div class="grid md:grid-cols-3 gap-4 text-sm">

          <!-- Active Plan -->
          <div class="border rounded-xl p-4 bg-white/80 flex flex-col gap-2">
            <div class="flex justify-between items-center">
              <p class="text-xs text-gray-500">Active Plan</p>
              <span id="dashPlanStatusPill" class="status-pill hidden"></span>
            </div>
            <p id="dashPlanName" class="font-semibold text-slate-800 text-sm">Loading...</p>
            <p id="dashPlanMeta" class="text-xs text-gray-500"></p>
            <button id="goToPlanFromCard"
                    class="mt-2 text-xs text-indigo-600 underline">
              View plan details
            </button>
          </div>

          <!-- Next Delivery -->
          <div class="border rounded-xl p-4 bg-white/80 flex flex-col gap-1">
            <p class="text-xs text-gray-500">Next Delivery</p>
            <p id="dashNextDelivery" class="font-semibold text-slate-800 text-sm">Loading...</p>
            <p id="dashNextDeliveryMeta" class="text-xs text-gray-500"></p>
          </div>

          <!-- Payment Summary -->
          <div class="border rounded-xl p-4 bg-white/80 flex flex-col gap-1">
            <p class="text-xs text-gray-500">Payments</p>
            <p id="dashLastPayment" class="font-semibold text-slate-800 text-sm">Loading...</p>
            <p id="dashPaymentMeta" class="text-xs text-gray-500"></p>
            <button id="dashViewPaymentsBtn"
                    class="mt-2 text-xs text-indigo-600 underline">
              View payment history
            </button>
          </div>

        </div>

        <!-- CALENDAR + QUICK ACTIONS -->
        <div class="grid md:grid-cols-3 gap-4">

          <!-- Delivery Calendar -->
          <div class="md:col-span-2 border rounded-xl p-4 bg-white/80 text-sm">
            <div class="flex justify-between items-center mb-2">
              <p class="font-semibold text-slate-800 text-sm">Upcoming Deliveries (7 days)</p>
              <button id="dashViewDeliveriesBtn"
                      class="text-xs text-indigo-600 underline">
                View delivery history
              </button>
            </div>

            <ul id="deliveryCalendarList" class="space-y-1 text-xs text-gray-700">
              <li class="text-gray-400">Loading...</li>
            </ul>

            <p class="mt-2 text-[11px] text-gray-400">
              You can skip a specific delivery from here.
            </p>
          </div>

          <!-- Quick Actions -->
          <div class="border rounded-xl p-4 bg-white/80 text-xs flex flex-col gap-2">
            <p class="font-semibold text-slate-800 mb-1">Quick Actions</p>
            <button id="qaPause" class="w-full border rounded-full px-3 py-1.5 text-left">
              Pause plan
            </button>
            <button id="qaResume" class="w-full border rounded-full px-3 py-1.5 text-left">
              Resume plan
            </button>
            <button id="qaCancel" class="w-full border rounded-full px-3 py-1.5 text-left text-red-600 border-red-300">
              Cancel plan
            </button>
            <button id="qaRenew" class="w-full border rounded-full px-3 py-1.5 text-left">
              Renew same plan
            </button>
            <button id="qaProfile" class="w-full border rounded-full px-3 py-1.5 text-left">
              Edit profile & address
            </button>

            <!-- Pay / Start Subscription -->
            <button id="qaPay" class="w-full border rounded-full px-3 py-1.5 text-left">
              Pay / Start subscription
            </button>

            <!-- Shortcut: Change Plan -->
            <button id="qaChangePlan" class="w-full border rounded-full px-3 py-1.5 text-left">
              Change plan / View plans
            </button>
          </div>

        </div>

      </section>

      <!-- PLANS IFRAME VIEW (data from /api/plans in plans.html) -->
      <section id="view-plans" class="glass p-0 space-y-0 hidden text-sm">
        <div class="flex items-center justify-between px-5 pt-4 pb-2">
          <div>
            <h3 class="font-semibold text-slate-800 text-base">All Subscription Plans</h3>
            <p class="text-[11px] text-gray-500">
              Choose a plan, then continue to checkout.
            </p>
          </div>
        </div>
        <div class="px-0 pb-0">
          <iframe id="plansIframe"
                  src="plans.html?from=dashboard"
                  style="width:100%;border:0;border-radius:0 0 18px 18px;min-height:420px;height:78vh;"></iframe>
        </div>
      </section>

      <!-- CHECKOUT IFRAME VIEW -->
      <section id="view-checkout" class="glass p-0 space-y-0 hidden text-sm">
        <div class="flex items-center justify-between px-5 pt-4 pb-2">
          <div>
            <h3 class="font-semibold text-slate-800 text-base">Checkout</h3>
            <p class="text-[11px] text-gray-500">
              Confirm your details and complete payment securely.
            </p>
          </div>
        </div>
        <div class="px-0 pb-0">
          <iframe id="checkoutIframe"
                  src=""
                  style="width:100%;border:0;border-radius:0 0 18px 18px;min-height:420px;height:78vh;"></iframe>
        </div>
      </section>

      <!-- MY PLAN -->
      <section id="view-plan" class="glass p-5 space-y-4 hidden text-sm">
        <h3 class="font-semibold text-slate-800 text-base">My Plan</h3>
        <p class="text-xs text-gray-500">View your active plan and subscription history.</p>

        <div class="border rounded-xl p-4 bg-white/80 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <p class="text-xs text-gray-500 mb-1">Active Plan</p>
            <p id="planViewName" class="font-semibold text-sm">No active plan</p>
            <p id="planViewMeta" class="text-xs text-gray-500 mt-1"></p>
            <p id="planViewDates" class="text-xs text-gray-500 mt-1"></p>
          </div>

          <div class="flex flex-wrap gap-2 text-xs">
            <button id="planPauseBtn" class="px-3 py-1.5 rounded-full border">Pause</button>
            <button id="planResumeBtn" class="px-3 py-1.5 rounded-full border">Resume</button>
            <button id="planCancelBtn" class="px-3 py-1.5 rounded-full border text-red-600 border-red-300">Cancel</button>
            <button id="planRenewBtn" class="px-3 py-1.5 rounded-full border">Renew</button>
            <button id="planChangeBtn" class="px-3 py-1.5 rounded-full border">
              Change Plan / View Plans
            </button>
          </div>
        </div>

        <!-- HISTORY -->
        <div class="border rounded-xl p-4 bg-white/80">
          <p class="font-semibold text-sm mb-2">Subscription History</p>

          <div class="overflow-x-auto">
            <table class="min-w-full text-xs">
              <thead>
                <tr class="text-left text-gray-500 border-b">
                  <th class="py-2 pr-4">Plan</th>
                  <th class="py-2 pr-4">Start</th>
                  <th class="py-2 pr-4">End</th>
                  <th class="py-2 pr-4">Status</th>
                </tr>
              </thead>
              <tbody id="subHistoryBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- DELIVERIES -->
      <section id="view-deliveries" class="glass p-5 space-y-4 hidden text-sm">
        <h3 class="font-semibold text-slate-800 text-base">Deliveries</h3>
        <p class="text-xs text-gray-500">Upcoming schedule and past deliveries.</p>

        <div class="border rounded-xl p-4 bg-white/80">
          <p class="font-semibold text-sm mb-2">Upcoming (next 7 days)</p>
          <ul id="delUpcomingList" class="space-y-1 text-xs text-gray-700">
            <li class="text-gray-400">Loading...</li>
          </ul>
        </div>

        <div class="border rounded-xl p-4 bg-white/80">
          <p class="font-semibold text-sm mb-2">Past Deliveries</p>
          <div class="overflow-x-auto">
            <table class="min-w-full text-xs">
              <thead>
                <tr class="text-left text-gray-500 border-b">
                  <th class="py-2 pr-4">Date</th>
                  <th class="py-2 pr-4">Status</th>
                  <th class="py-2 pr-4">Notes</th>
                </tr>
              </thead>
              <tbody id="deliveryHistoryBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PAYMENTS -->
      <section id="view-payments" class="glass p-5 space-y-4 hidden text-sm">
        <h3 class="font-semibold text-slate-800 text-base">Payments</h3>
        <p class="text-xs text-gray-500">All your payments and invoices.</p>

        <button id="downloadLastInvoiceBtn"
                class="px-3 py-1.5 rounded-full border text-xs">
          Download last invoice
        </button>

        <div class="border rounded-xl p-4 bg-white/80">
          <div class="overflow-x-auto">
            <table class="min-w-full text-xs">
              <thead>
                <tr class="text-left text-gray-500 border-b">
                  <th class="py-2 pr-4">Date</th>
                  <th class="py-2 pr-4">Plan</th>
                  <th class="py-2 pr-4">Amount</th>
                  <th class="py-2 pr-4">Method</th>
                  <th class="py-2 pr-4">Status</th>
                </tr>
              </thead>
              <tbody id="paymentHistoryBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="view-profile" class="glass p-5 space-y-4 hidden text-sm">
        <h3 class="font-semibold text-slate-800 text-base">Profile & Address</h3>
        <p class="text-xs text-gray-500">Update your basic details and delivery address.</p>

        <form id="profileForm" class="space-y-4">

          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-semibold">Full Name *</label>
              <input id="pfFullName" type="text" required class="w-full px-3 py-2 border rounded-md bg-white/80">
            </div>
            <div>
              <label class="block text-xs font-semibold">Email *</label>
              <input id="pfEmail" type="email" disabled class="w-full px-3 py-2 border rounded-md bg-gray-100">
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-semibold">Phone *</label>
              <input id="pfPhone" type="tel" required class="w-full px-3 py-2 border rounded-md bg-white/80">
            </div>
            <div>
              <label class="block text-xs font-semibold">User Type</label>
              <select id="pfUserType" class="w-full px-3 py-2 border rounded-md bg-white/80">
                <option value="">Customer</option>
                <option value="home">Home</option>
                <option value="office">Office</option>
                <option value="corporate">Corporate</option>
              </select>
            </div>
          </div>

          <!-- ADDRESS -->
          <div class="border-t pt-3">
            <label class="block text-xs font-semibold mb-2">Primary Delivery Address</label>

            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-medium">House *</label>
                <input id="pfHouse" type="text" required class="w-full px-3 py-2 border rounded bg-white/80">
              </div>
              <div>
                <label class="block text-xs font-medium">Street *</label>
                <input id="pfStreet" type="text" required class="w-full px-3 py-2 border rounded bg-white/80">
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4 mt-3">
              <div>
                <label class="block text-xs text-xs font-medium">Area *</label>
                <input id="pfArea" type="text" required class="w-full px-3 py-2 border rounded bg-white/80">
              </div>
              <div>
                <label class="block text-xs font-medium">City *</label>
                <input id="pfCity" type="text" required class="w-full px-3 py-2 border rounded bg-white/80">
              </div>
            </div>

            <div class="mt-3 max-w-xs">
              <label class="block text-xs font-medium">Pincode *</label>
              <input id="pfPincode" type="text" required class="w-full px-3 py-2 border rounded bg-white/80">
            </div>
          </div>

          <div class="border-t pt-3 space-y-2">
            <label class="text-xs font-semibold">Preferred Delivery Time</label>
            <select id="pfDeliveryTime" class="w-full md:w-60 px-3 py-2 border rounded bg-white/80 text-sm">
              <option value="">Select...</option>
              <option value="morning">Morning (6:30–9)</option>
              <option value="afternoon">Afternoon</option>
              <option value="evening">Evening</option>
            </select>

            <label class="flex items-center gap-2 text-xs">
              <input id="pfOffersOptIn" type="checkbox">
              Receive deals & updates
            </label>
          </div>

          <button type="submit"
                  class="px-6 py-2.5 rounded-full text-white text-sm font-semibold"
                  style="background:linear-gradient(90deg,#06b6d4,#7c3aed);">
            Save Profile
          </button>
        </form>

        <!-- Subscription & Billing summary (cards BELOW profile form) -->
        <div class="border-t pt-4 space-y-4">
          <h4 class="font-semibold text-sm text-slate-800">Subscription & Billing</h4>

          <!-- Subscription card -->
          <div class="border rounded-xl p-4 bg-white/80 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <p class="text-xs text-gray-500 mb-1">Active Plan</p>
              <p id="profileSubName" class="font-semibold text-sm">No active plan</p>
              <p id="profileSubMeta" class="text-xs text-gray-500 mt-1"></p>
              <p id="profileSubDates" class="text-xs text-gray-500 mt-1"></p>
              <p id="profileSubExpiryAlert" class="text-[11px] mt-1 text-amber-600"></p>
            </div>

            <div class="flex flex-wrap gap-2 text-xs">
              <button id="profilePauseBtn" class="px-3 py-1.5 rounded-full border">Pause</button>
              <button id="profileResumeBtn" class="px-3 py-1.5 rounded-full border">Resume</button>
              <button id="profileCancelBtn" class="px-3 py-1.5 rounded-full border text-red-600 border-red-300">Cancel</button>
              <button id="profileRenewBtn" class="px-3 py-1.5 rounded-full border">Renew</button>
              <button id="profileChangeBtn" class="px-3 py-1.5 rounded-full border">Change Plan</button>
            </div>
          </div>

          <!-- Billing & mini payment history -->
          <div class="border rounded-xl p-4 bg-white/80 text-xs space-y-2">
            <div class="flex items-center justify-between">
              <p class="font-semibold text-slate-800 text-sm">Billing & Payments</p>
              <button id="profileViewPaymentsBtn"
                      class="text-[11px] text-indigo-600 underline">
                View all payments
              </button>
            </div>
            <p id="profileLastPaymentText" class="text-xs text-gray-600">
              Loading payment info...
            </p>
            <div class="overflow-x-auto mt-2">
              <table class="min-w-full text-[11px]">
                <thead>
                  <tr class="text-left text-gray-500 border-b">
                    <th class="py-1 pr-3">Date</th>
                    <th class="py-1 pr-3">Plan</th>
                    <th class="py-1 pr-3">Amount</th>
                    <th class="py-1 pr-3">Status</th>
                  </tr>
                </thead>
                <tbody id="profilePaymentMiniBody"></tbody>
              </table>
            </div>
          </div>
        </div>

      </section>

    </div>

  </main>
</div>

<!-- FOOTER -->
<footer class="mt-8 pb-6 text-center text-[11px] text-gray-400">
  © 2025 Daily Fruit Co. — Freshness Delivered Daily
</footer>

<script>
/* ================================
   CONFIG
================================ */
const API_BASE = "https://dailyfruit-backend.onrender.com";

/* ================================
   TOAST
================================ */
function toast(msg, isError=false){
  const div = document.createElement("div");
  div.textContent = msg;
  div.className =
    "fixed bottom-4 right-4 px-3 py-2 rounded text-white text-sm shadow " +
    (isError ? "bg-red-600" : "bg-black");
  document.body.appendChild(div);
  setTimeout(()=> div.remove(), 2600);
}

/* ================================
   SESSION MANAGEMENT
================================ */
function getSession(){
  const token = localStorage.getItem("df_user_token");
  const expiry = Number(localStorage.getItem("df_session_expiry") || 0);
  if(!token || !expiry) return null;
  if(Date.now() > expiry) return null;
  return { token, expiry };
}

function requireLogin(){
  const session = getSession();
  if(!session){
    window.location.href = "login.html?redirect=dashboard.html";
    return null;
  }
  return session.token;
}

function logout(){
  localStorage.removeItem("df_user_token");
  localStorage.removeItem("df_session_expiry");
  localStorage.removeItem("df_user_profile");
  window.location.href = "login.html";
}

/* ================================
   GLOBAL STATE
================================ */
let gProfile = null;
let gActiveSub = null;
let gSubHistory = [];
let gUpcomingDeliveries = [];
let gDeliveryHistory = [];
let gPaymentHistory = [];

/* ================================
   PAGE LOAD (LOGIN CHECK)
================================ */
document.addEventListener("DOMContentLoaded", async () => {
  const token = requireLogin();
  if(!token) return;

  initSidebar();
  initDesktopSidebarHover();
  initMobileSidebar();
  initLogout();
  initProfileForm();
  initQuickActions();
  initMessageBridge();
  initProfileMenu();

  await loadAllData(token);
});

/* ================================
   SIDEBAR + VIEW HANDLING
================================ */
function ensurePlansIframe(){
  const iframe = document.getElementById("plansIframe");
  if (iframe && !iframe.src){
    // plans.html will fetch /api/plans (MongoDB)
    iframe.src = "plans.html?from=dashboard";
  }
}

function ensureCheckoutIframe(){
  const iframe = document.getElementById("checkoutIframe");
  if (iframe && !iframe.src){
    iframe.src = "checkout.html?from=dashboard";
  } else if (iframe && iframe.contentWindow){
    // reload to reflect new selected plan
    iframe.contentWindow.location.reload();
  }
}

function initSidebar(){
  document.querySelectorAll(".sidebar-link[data-view]").forEach(btn => {
    btn.onclick = () => {
      const v = btn.dataset.view;
      showView(v);
      if (v === "plans") ensurePlansIframe();
    };
  });

  const goPlan = document.getElementById("goToPlanFromCard");
  if (goPlan) goPlan.onclick = () => showView("plan");

  const delBtn = document.getElementById("dashViewDeliveriesBtn");
  if (delBtn) delBtn.onclick = () => showView("deliveries");

  const payBtn = document.getElementById("dashViewPaymentsBtn");
  if (payBtn) payBtn.onclick = () => showView("payments");
}

function showView(v){
  document.querySelectorAll('[id^="view-"]').forEach(sec => sec.classList.add("hidden"));
  const targetId = (v === "plans") ? "view-plans"
                  : (v === "checkout") ? "view-checkout"
                  : "view-" + v;
  const target = document.getElementById(targetId);
  if (target) target.classList.remove("hidden");

  document.querySelectorAll(".sidebar-link").forEach(b => {
    if(b.dataset.view){
      b.classList.remove("active");
      if(b.dataset.view === v) b.classList.add("active");
    }
  });
}

/* Desktop sidebar hover behaviour */
function initDesktopSidebarHover(){
  const sidebar = document.getElementById("desktopSidebar");
  if(!sidebar) return;
  sidebar.classList.remove("sidebar-expanded");
  sidebar.classList.add("sidebar-collapsed");

  sidebar.addEventListener("mouseenter", () => {
    sidebar.classList.remove("sidebar-collapsed");
    sidebar.classList.add("sidebar-expanded");
  });
  sidebar.addEventListener("mouseleave", () => {
    sidebar.classList.remove("sidebar-expanded");
    sidebar.classList.add("sidebar-collapsed");
  });
}

/* Mobile sidebar drawer */
function initMobileSidebar(){
  const overlay = document.getElementById("mobileSidebarOverlay");
  const openBtn = document.getElementById("mobileMenuBtn");
  const logoutBtn = document.getElementById("mobileLogoutBtn");
  if(!overlay || !openBtn) return;

  const open = () => overlay.classList.remove("hidden");
  const close = () => overlay.classList.add("hidden");

  openBtn.addEventListener("click", open);
  overlay.addEventListener("click", (e) => {
    if(e.target === overlay) close();
  });

  overlay.querySelectorAll("[data-close-mobile]").forEach(el => {
    el.addEventListener("click", close);
  });

  if(logoutBtn){
    logoutBtn.addEventListener("click", () => {
      if(confirm("Logout from your account?")){
        logout();
      }
    });
  }
}

/* ================================
   PROFILE DROPDOWN MENU
================================ */
function initProfileMenu(){
  const btn = document.getElementById("profileMenuBtn");
  const menu = document.getElementById("profileMenu");
  if(!btn || !menu) return;

  btn.addEventListener("click", (e)=>{
    e.stopPropagation();
    menu.classList.toggle("hidden");
  });

  document.addEventListener("click", ()=>{
    menu.classList.add("hidden");
  });

  const profileBtn = document.getElementById("menuProfileBtn");
  const paymentsBtn = document.getElementById("menuPaymentsBtn");
  const logoutBtn = document.getElementById("menuLogoutBtn");

  if(profileBtn){
    profileBtn.onclick = (e)=>{
      e.preventDefault();
      showView("profile");
      menu.classList.add("hidden");
    };
  }

  if(paymentsBtn){
    paymentsBtn.onclick = (e)=>{
      e.preventDefault();
      showView("payments");
      menu.classList.add("hidden");
    };
  }

  if(logoutBtn){
    logoutBtn.onclick = (e)=>{
      e.preventDefault();
      menu.classList.add("hidden");
      if(confirm("Logout from your account?")){
        logout();
      }
    };
  }
}

/* ================================
   MESSAGE BRIDGE (plans <-> checkout <-> dashboard)
================================ */
function initMessageBridge(){
  window.addEventListener("message", (event) => {
    const data = event.data || {};
    if (data.type === "OPEN_CHECKOUT") {
      // a plan was selected inside plans.html
      showView("checkout");
      ensureCheckoutIframe();
    }
    if (data.type === "PAYMENT_SUCCESS") {
      toast("Payment successful! Updating dashboard…");
      const session = getSession();
      if (session){
        loadAllData(session.token);
      }
      showView("dashboard");
    }
  });
}

/* ================================
   LOGOUT
================================ */
function initLogout(){
  const btn = document.getElementById("logoutBtn");
  if(!btn) return;
  btn.onclick = () => {
    if(confirm("Logout from your account?")){
      logout();
    }
  };
}

/* ================================
   LOAD ALL DATA
================================ */
async function loadAllData(token){
  try {
    await Promise.all([
      loadProfile(token),
      loadActiveSubscription(token),
      loadSubscriptionHistory(token),
      loadUpcomingDeliveries(token),
      loadDeliveryHistory(token),
      loadPaymentHistory(token)
    ]);

    renderHeader();
    renderDashboardCards();
    renderPlanView();
    renderSubHistory();
    renderDeliveryCalendar();
    renderDeliveriesView();
    renderPaymentsView();
    renderProfileSubscriptionAndBilling();
    fillProfileForm();

  } catch (e){
    console.error(e);
    toast("Error loading dashboard", true);
  }
}

/* ================================
   LOAD PROFILE
================================ */
async function loadProfile(token){
  const res = await fetch(API_BASE + "/api/profile/me", {
    headers: { Authorization: "Bearer " + token }
  });

  if(res.status === 401){
    return requireLogin();
  }

  const u = await res.json();
  gProfile = u;
  localStorage.setItem("df_user_profile", JSON.stringify(u));
}

/* ================================
   LOAD ACTIVE SUBSCRIPTION
================================ */
async function loadActiveSubscription(token){
  const res = await fetch(API_BASE + "/api/subscriptions/my-active", {
    headers: { Authorization: "Bearer " + token }
  });
  gActiveSub = await res.json().catch(()=> null);
}

/* ================================
   LOAD HISTORY + DELIVERIES + PAYMENTS
================================ */
async function loadSubscriptionHistory(token){
  const r = await fetch(API_BASE + "/api/subscriptions/me", {
    headers: { Authorization: "Bearer " + token }
  });
  gSubHistory = await r.json().catch(()=> []);
}

async function loadUpcomingDeliveries(token){
  const r = await fetch(API_BASE + "/api/deliveries/upcoming", {
    headers: { Authorization: "Bearer " + token }
  });
  gUpcomingDeliveries = await r.json().catch(()=> []);
}

async function loadDeliveryHistory(token){
  const r = await fetch(API_BASE + "/api/deliveries/history", {
    headers: { Authorization: "Bearer " + token }
  });
  gDeliveryHistory = await r.json().catch(()=> []);
}

async function loadPaymentHistory(token){
  const r = await fetch(API_BASE + "/api/payments/my-payments", {
    headers: { Authorization: "Bearer " + token }
  });
  gPaymentHistory = await r.json().catch(()=> []);
}

/* ================================
   RENDER HEADER
================================ */
function renderHeader(){
  if(!gProfile) return;
  const name = gProfile.name || "Customer";
  const email = gProfile.email || "-";

  const hdrName = document.getElementById("hdrUserName");
  if (hdrName) hdrName.textContent = name;

  const sideName = document.getElementById("sidebarUserName");
  if (sideName) sideName.textContent = name;

  const mobileSideName = document.getElementById("mobileSidebarUserName");
  if (mobileSideName) mobileSideName.textContent = name;

  const menuName = document.getElementById("menuUserName");
  if (menuName) menuName.textContent = name;

  const menuEmail = document.getElementById("menuUserEmail");
  if (menuEmail) menuEmail.textContent = email;
}

/* ================================
   RENDER DASHBOARD CARDS
================================ */
function renderDashboardCards(){
  const planName = document.getElementById("dashPlanName");
  const planMeta = document.getElementById("dashPlanMeta");
  const statusPill = document.getElementById("dashPlanStatusPill");

  if(!gActiveSub || !gActiveSub._id){
    planName.textContent = "No active plan";
    planMeta.textContent = "Start a subscription from the plans page.";
    statusPill.classList.add("hidden");
  } else {
    planName.textContent = gActiveSub.planName;
    planMeta.textContent = `Status: ${gActiveSub.status}`;
    statusPill.textContent = gActiveSub.status;
    statusPill.classList.remove("hidden");
  }

  // Next delivery
  const next = gUpcomingDeliveries[0];
  const nextEl = document.getElementById("dashNextDelivery");
  const nextMetaEl = document.getElementById("dashNextDeliveryMeta");

  if(next){
    nextEl.textContent = new Date(next.deliveryDate).toDateString();
    nextMetaEl.textContent = next.status;
  } else {
    nextEl.textContent = "No upcoming delivery";
    if(nextMetaEl) nextMetaEl.textContent = "";
  }

  // Last payment
  const last = gPaymentHistory[0];
  const lastPay = document.getElementById("dashLastPayment");
  const payMeta = document.getElementById("dashPaymentMeta");

  if(last){
    lastPay.textContent = "₹" + last.amount;
    payMeta.textContent = last.planName;
  } else {
    lastPay.textContent = "No payments yet";
    if(payMeta) payMeta.textContent = "";
  }
}

/* ================================
   PLAN VIEW
================================ */
function renderPlanView(){
  const name = document.getElementById("planViewName");
  const meta = document.getElementById("planViewMeta");
  const dates = document.getElementById("planViewDates");

  if(!gActiveSub){
    name.textContent = "No active plan";
    meta.textContent = "";
    dates.textContent = "";
    return;
  }

  name.textContent = gActiveSub.planName;
  meta.textContent = "Status: " + gActiveSub.status;

  const s = new Date(gActiveSub.startDate).toLocaleDateString("en-IN");
  const e = new Date(gActiveSub.endDate).toLocaleDateString("en-IN");

  dates.textContent = `From ${s} to ${e}`;
}

/* ================================
   SUB HISTORY
================================ */
function renderSubHistory(){
  const body = document.getElementById("subHistoryBody");
  body.innerHTML = "";

  gSubHistory.forEach(sub => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="py-2 pr-4">${sub.planName}</td>
      <td class="py-2 pr-4">${new Date(sub.startDate).toLocaleDateString("en-IN")}</td>
      <td class="py-2 pr-4">${new Date(sub.endDate).toLocaleDateString("en-IN")}</td>
      <td class="py-2 pr-4 capitalize">${sub.status}</td>
    `;
    body.appendChild(tr);
  });
}

/* ================================
   DELIVERY CALENDAR
================================ */
function renderDeliveryCalendar(){
  const list = document.getElementById("deliveryCalendarList");
  list.innerHTML = "";

  if(gUpcomingDeliveries.length === 0){
    list.innerHTML = `<li class="text-gray-400">No deliveries scheduled.</li>`;
    return;
  }

  gUpcomingDeliveries.forEach(del => {
    const li = document.createElement("li");
    li.className = "flex justify-between py-1 text-xs";
    li.innerHTML = `
      <span>${new Date(del.deliveryDate).toDateString()}</span>
      <button onclick="skipDelivery('${del._id}')" class="text-red-600 text-[11px]">Skip</button>
    `;
    list.appendChild(li);
  });
}

/* ================================
   FULL DELIVERY VIEW
================================ */
function renderDeliveriesView(){
  const up = document.getElementById("delUpcomingList");
  up.innerHTML = "";

  gUpcomingDeliveries.forEach(del => {
    const li = document.createElement("li");
    li.className = "flex justify-between py-1 text-xs";
    li.innerHTML = `
      <span>${new Date(del.deliveryDate).toDateString()}</span>
      <button onclick="skipDelivery('${del._id}')" class="text-red-600 text-[11px]">Skip</button>
    `;
    up.appendChild(li);
  });

  const hist = document.getElementById("deliveryHistoryBody");
  hist.innerHTML = "";

  gDeliveryHistory.forEach(d => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="py-2 pr-4">${new Date(d.deliveryDate).toLocaleDateString("en-IN")}</td>
      <td class="py-2 pr-4">${d.status}</td>
      <td class="py-2 pr-4">${d.notes || "-"}</td>
    `;
    hist.appendChild(tr);
  });
}

/* ================================
   PAYMENTS VIEW
================================ */
function renderPaymentsView(){
  const body = document.getElementById("paymentHistoryBody");
  body.innerHTML = "";

  gPaymentHistory.forEach(p => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="py-2 pr-4">${new Date(p.createdAt).toLocaleDateString("en-IN")}</td>
      <td class="py-2 pr-4">${p.planName}</td>
      <td class="py-2 pr-4">₹${p.amount}</td>
      <td class="py-2 pr-4">${p.razorpayPaymentId ? "Razorpay" : "Offline"}</td>
      <td class="py-2 pr-4">${p.status}</td>
    `;
    body.appendChild(tr);
  });
}

/* ================================
   PROFILE SUBSCRIPTION + BILLING
================================ */
function renderProfileSubscriptionAndBilling(){
  const subName = document.getElementById("profileSubName");
  const subMeta = document.getElementById("profileSubMeta");
  const subDates = document.getElementById("profileSubDates");
  const subAlert = document.getElementById("profileSubExpiryAlert");

  if(!subName) return;

  if(!gActiveSub || !gActiveSub._id){
    subName.textContent = "No active plan";
    subMeta.textContent = "You don't have any active subscription yet.";
    subDates.textContent = "";
    subAlert.textContent = "";
  } else {
    subName.textContent = gActiveSub.planName;
    subMeta.textContent = "Status: " + (gActiveSub.status || "active");

    const sDate = new Date(gActiveSub.startDate);
    const eDate = new Date(gActiveSub.endDate);
    subDates.textContent =
      `Start: ${sDate.toLocaleDateString("en-IN")} • End: ${eDate.toLocaleDateString("en-IN")}`;

    const now = new Date();
    const diffMs = eDate - now;

    if(diffMs > 0){
      const daysLeft = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
      if(daysLeft <= 5 && gActiveSub.status === "active"){
        subAlert.textContent =
          `⏰ Plan expiring in ${daysLeft} day${daysLeft>1 ? "s" : ""}. You can renew now.`;
      } else {
        subAlert.textContent = "";
      }
    } else if(gActiveSub.status === "expired"){
      subAlert.textContent = "Your plan has expired. Renew to restart your deliveries.";
    } else {
      subAlert.textContent = "";
    }
  }

  // Billing + mini payment list
  const lastTxt = document.getElementById("profileLastPaymentText");
  const miniBody = document.getElementById("profilePaymentMiniBody");
  if(!lastTxt || !miniBody) return;

  miniBody.innerHTML = "";
  if(!gPaymentHistory || gPaymentHistory.length === 0){
    lastTxt.textContent = "No payments found yet.";
    const tr = document.createElement("tr");
    tr.innerHTML = `<td class="py-1 pr-3 text-gray-400" colspan="4">No payments yet.</td>`;
    miniBody.appendChild(tr);
  } else {
    const last = gPaymentHistory[0];
    lastTxt.textContent =
      `Last payment: ₹${last.amount} for ${last.planName} on ` +
      `${new Date(last.createdAt).toLocaleDateString("en-IN")} (${last.status}).`;

    gPaymentHistory.slice(0, 5).forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="py-1 pr-3">${new Date(p.createdAt).toLocaleDateString("en-IN")}</td>
        <td class="py-1 pr-3">${p.planName}</td>
        <td class="py-1 pr-3">₹${p.amount}</td>
        <td class="py-1 pr-3">${p.status}</td>
      `;
      miniBody.appendChild(tr);
    });
  }
}

/* ================================
   SKIP DELIVERY
================================ */
async function skipDelivery(id){
  const session = getSession();
  if(!session) return requireLogin();

  const r = await fetch(API_BASE + "/api/deliveries/skip/" + id, {
    method: "POST",
    headers: { Authorization: "Bearer " + session.token }
  });

  const d = await r.json();
  toast(d.message || "Updated");

  await loadUpcomingDeliveries(session.token);
  await loadDeliveryHistory(session.token);

  renderDeliveryCalendar();
  renderDeliveriesView();
}
window.skipDelivery = skipDelivery;

/* ================================
   QUICK ACTIONS & SUB ACTIONS
================================ */
function initQuickActions(){
  const session = getSession();
  if(!session) return;
  const token = session.token;

  const setClick = (id, fn) => {
    const el = document.getElementById(id);
    if(el) el.onclick = fn;
  };

  // Quick actions
  setClick("qaPause", ()=>subAction("pause", token));
  setClick("qaResume", ()=>subAction("resume", token));
  setClick("qaCancel", ()=>subAction("cancel", token));
  setClick("qaRenew", ()=>subAction("renew", token));
  setClick("qaProfile", ()=>showView("profile"));
  setClick("qaChangePlan", ()=>{
    showView("plans");
    ensurePlansIframe();
  });
  setClick("qaPay", ()=>{
    if(confirm("Continue to choose a plan and go to checkout?")){
      showView("plans");
      ensurePlansIframe();
    }
  });

  // My Plan buttons
  setClick("planPauseBtn", ()=>subAction("pause", token));
  setClick("planResumeBtn", ()=>subAction("resume", token));
  setClick("planCancelBtn", ()=>subAction("cancel", token));
  setClick("planRenewBtn", ()=>subAction("renew", token));
  setClick("planChangeBtn", ()=>{
    showView("plans");
    ensurePlansIframe();
  });

  // Profile subscription card buttons
  setClick("profilePauseBtn", ()=>subAction("pause", token));
  setClick("profileResumeBtn", ()=>subAction("resume", token));
  setClick("profileCancelBtn", ()=>subAction("cancel", token));
  setClick("profileRenewBtn", ()=>subAction("renew", token));
  setClick("profileChangeBtn", ()=>{
    showView("plans");
    ensurePlansIframe();
  });
  setClick("profileViewPaymentsBtn", ()=>{
    showView("payments");
  });
}

async function subAction(type, token){
  if(!gActiveSub){
    toast("No active subscription", true);
    return;
  }

  const r = await fetch(API_BASE + "/api/subscriptions/" + gActiveSub._id + "/" + type, {
    method: "POST",
    headers: { Authorization: "Bearer " + token }
  });

  const d = await r.json();
  toast(d.message || "Updated");

  await loadActiveSubscription(token);
  await loadUpcomingDeliveries(token);
  await loadDeliveryHistory(token);

  renderDashboardCards();
  renderPlanView();
  renderDeliveryCalendar();
  renderDeliveriesView();
  renderProfileSubscriptionAndBilling();
}

/* ================================
   PROFILE FORM
================================ */
function initProfileForm(){
  const form = document.getElementById("profileForm");
  if(!form) return;
  form.onsubmit = submitProfile;
}

function fillProfileForm(){
  if(!gProfile) return;

  document.getElementById("pfFullName").value = gProfile.name || "";
  document.getElementById("pfEmail").value = gProfile.email || "";
  document.getElementById("pfPhone").value = gProfile.phone || "";

  document.getElementById("pfUserType").value = gProfile.userType || "";
  document.getElementById("pfHouse").value = gProfile.addressDetails?.house || "";
  document.getElementById("pfStreet").value = gProfile.addressDetails?.street || "";
  document.getElementById("pfArea").value = gProfile.addressDetails?.area || "";
  document.getElementById("pfCity").value = gProfile.addressDetails?.city || "";
  document.getElementById("pfPincode").value = gProfile.addressDetails?.pincode || "";
  document.getElementById("pfDeliveryTime").value = gProfile.deliveryTime || "";
  document.getElementById("pfOffersOptIn").checked = !!gProfile.offersOptIn;
}

async function submitProfile(e){
  e.preventDefault();

  const session = getSession();
  if(!session) return requireLogin();

  const payload = {
    fullName: document.getElementById("pfFullName").value,
    phone: document.getElementById("pfPhone").value,
    userType: document.getElementById("pfUserType").value,
    offersOptIn: document.getElementById("pfOffersOptIn").checked,
    deliveryTime: document.getElementById("pfDeliveryTime").value,
    addressDetails: {
      house: document.getElementById("pfHouse").value,
      street: document.getElementById("pfStreet").value,
      area: document.getElementById("pfArea").value,
      city: document.getElementById("pfCity").value,
      pincode: document.getElementById("pfPincode").value
    }
  };

  const r = await fetch(API_BASE + "/api/profile/update", {
    method: "POST",
    headers:{
      "Content-Type": "application/json",
      Authorization: "Bearer " + session.token
    },
    body: JSON.stringify(payload)
  });

  const d = await r.json();
  toast(d.message || "Profile Updated");

  await loadProfile(session.token);
  renderHeader();
}

/* ================================
   INVOICE DOWNLOAD
================================ */
function initInvoiceDownload(){
  const btn = document.getElementById("downloadLastInvoiceBtn");
  if(!btn) return;
  btn.addEventListener("click", async () => {
    if(!gPaymentHistory || gPaymentHistory.length === 0){
      toast("No payments yet", true);
      return;
    }
    const session = getSession();
    if(!session) return requireLogin();
    const last = gPaymentHistory[0];

    const url = API_BASE + "/api/invoices/payment/" + last._id + "/download";

    // open new tab so browser download works nicely
    window.open(url + "?token=" + encodeURIComponent(session.token), "_blank");
  });
}
initInvoiceDownload();
</script>

</body>
</html>
