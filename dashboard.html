<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard — Daily Fruit Co.</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <!-- Icons -->
  <script src="https://kit.fontawesome.com/0c9b1f3f2d.js" crossorigin="anonymous"></script>

  <style>
    body{
      font-family:'Inter',sans-serif;
      background:linear-gradient(180deg,#f8fafc,#eef7ff);
      color:#0f172a;
    }
    .glass{
      background:rgba(255,255,255,0.9);
      backdrop-filter:blur(12px);
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.4);
      box-shadow:0 10px 30px rgba(15,23,42,0.12);
    }
    .section-title{
      background:linear-gradient(90deg,#06b6d4,#7c3aed);
      -webkit-background-clip:text;
      color:transparent;
      font-weight:800;
    }
    .sidebar-link{
      display:flex;
      align-items:center;
      gap:10px;
      padding:0.6rem 0.9rem;
      border-radius:999px;
      font-size:0.85rem;
      cursor:pointer;
      color:#e5e7eb;
      transition:.2s;
    }
    .sidebar-link:hover{
      background:rgba(148,163,184,0.2);
    }
    .sidebar-link.active{
      background:linear-gradient(90deg,#06b6d4,#7c3aed);
      color:white;
      box-shadow:0 8px 20px rgba(37,99,235,0.35);
    }
    .status-pill{
      border-radius:999px;
      font-size:0.75rem;
      padding:0.15rem 0.6rem;
    }
    .status-active{
      background:#dcfce7;
      color:#166534;
    }
    .status-paused{
      background:#fef3c7;
      color:#92400e;
    }
    .status-cancelled{
      background:#fee2e2;
      color:#b91c1c;
    }
    .status-expired{
      background:#e5e7eb;
      color:#374151;
    }
  </style>
</head>

<body>

<!-- HEADER -->
<header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b">
  <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
    <a href="index.html" class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-teal-400 text-white flex items-center justify-center font-bold shadow">
        DF
      </div>
      <div>
        <h1 class="text-lg font-semibold">Daily Fruit Co.</h1>
        <p class="text-xs text-gray-500">Freshness Delivered Daily</p>
      </div>
    </a>

    <div class="text-xs text-gray-500 hidden sm:block">
      Logged in as <span id="hdrUserEmail">...</span>
    </div>
  </div>
</header>

<!-- LAYOUT -->
<div class="max-w-6xl mx-auto px-4 py-6 flex gap-5">

  <!-- SIDEBAR -->
  <aside class="w-64 hidden md:block">
    <div class="glass p-4 sticky top-24">
      <div class="mb-4">
        <p class="text-xs text-gray-500 mb-1">Welcome</p>
        <p id="sidebarUserName" class="font-semibold text-slate-800 text-sm">User</p>
      </div>

      <nav class="flex flex-col gap-1 text-xs">
        <button class="sidebar-link active" data-view="dashboard">
          <i class="fa fa-chart-pie"></i> Dashboard Home
        </button>
        <button class="sidebar-link" data-view="plan">
          <i class="fa fa-seedling"></i> My Plan
        </button>
        <button class="sidebar-link" data-view="deliveries">
          <i class="fa fa-truck"></i> Deliveries
        </button>
        <button class="sidebar-link" data-view="payments">
          <i class="fa fa-receipt"></i> Payments
        </button>
        <button class="sidebar-link" data-view="profile">
          <i class="fa fa-user"></i> Profile
        </button>
      </nav>

      <hr class="my-3 border-slate-200">

      <button id="logoutBtn" class="sidebar-link text-red-300">
        <i class="fa fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </aside>
  <!-- MAIN CONTENT -->
  <main class="flex-1 space-y-4">

    <!-- PAGE TITLE + QUICK ACTIONS -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h2 class="text-2xl md:text-3xl font-extrabold section-title">My Dashboard</h2>
        <p class="text-xs text-gray-500 mt-1">
          Manage your plan, deliveries, payments and profile in one place.
        </p>
      </div>
      <div class="flex flex-wrap gap-2 text-xs">
        <a href="mailto:dailyfruitco@gmail.com"
           class="px-3 py-2 rounded-full text-white"
           style="background:linear-gradient(90deg,#06b6d4,#7c3aed);">
          <i class="fa fa-headset mr-1"></i> Support
        </a>
      </div>
    </div>

    <!-- VIEWS WRAPPER -->
    <div class="space-y-4">

      <!-- DASHBOARD HOME VIEW -->
      <section id="view-dashboard" class="glass p-5 space-y-5">

        <!-- TOP CARDS -->
        <div class="grid md:grid-cols-3 gap-4 text-sm">

          <!-- Active Plan -->
          <div class="border rounded-xl p-4 bg-white/80 flex flex-col gap-2">
            <div class="flex justify-between items-center">
              <p class="text-xs text-gray-500">Active Plan</p>
              <span id="dashPlanStatusPill" class="status-pill hidden"></span>
            </div>
            <p id="dashPlanName" class="font-semibold text-slate-800 text-sm">Loading...</p>
            <p id="dashPlanMeta" class="text-xs text-gray-500"></p>
            <button id="goToPlanFromCard"
                    class="mt-2 text-xs text-indigo-600 underline">
              View plan details
            </button>
          </div>

          <!-- Next Delivery -->
          <div class="border rounded-xl p-4 bg-white/80 flex flex-col gap-1">
            <p class="text-xs text-gray-500">Next Delivery</p>
            <p id="dashNextDelivery" class="font-semibold text-slate-800 text-sm">Loading...</p>
            <p id="dashNextDeliveryMeta" class="text-xs text-gray-500"></p>
          </div>

          <!-- Payment Summary -->
          <div class="border rounded-xl p-4 bg-white/80 flex flex-col gap-1">
            <p class="text-xs text-gray-500">Payments</p>
            <p id="dashLastPayment" class="font-semibold text-slate-800 text-sm">Loading...</p>
            <p id="dashPaymentMeta" class="text-xs text-gray-500"></p>
            <button id="dashViewPaymentsBtn"
                    class="mt-2 text-xs text-indigo-600 underline">
              View payment history
            </button>
          </div>

        </div>

        <!-- CALENDAR + QUICK ACTIONS -->
        <div class="grid md:grid-cols-3 gap-4">

          <!-- Delivery Calendar -->
          <div class="md:col-span-2 border rounded-xl p-4 bg-white/80 text-sm">
            <div class="flex justify-between items-center mb-2">
              <p class="font-semibold text-slate-800 text-sm">Upcoming Deliveries (7 days)</p>
              <button id="dashViewDeliveriesBtn"
                      class="text-xs text-indigo-600 underline">
                View delivery history
              </button>
            </div>

            <ul id="deliveryCalendarList" class="space-y-1 text-xs text-gray-700">
              <li class="text-gray-400">Loading...</li>
            </ul>

            <p class="mt-2 text-[11px] text-gray-400">
              You can skip a specific delivery from here.
            </p>
          </div>

          <!-- Quick Actions -->
          <div class="border rounded-xl p-4 bg-white/80 text-xs flex flex-col gap-2">
            <p class="font-semibold text-slate-800 mb-1">Quick Actions</p>
            <button id="qaPause" class="w-full border rounded-full px-3 py-1.5 text-left">
              Pause plan
            </button>
            <button id="qaResume" class="w-full border rounded-full px-3 py-1.5 text-left">
              Resume plan
            </button>
            <button id="qaCancel" class="w-full border rounded-full px-3 py-1.5 text-left text-red-600 border-red-300">
              Cancel plan
            </button>
            <button id="qaRenew" class="w-full border rounded-full px-3 py-1.5 text-left">
              Renew same plan
            </button>
            <button id="qaProfile" class="w-full border rounded-full px-3 py-1.5 text-left">
              Edit profile & address
            </button>
          </div>

        </div>

      </section>

      <!-- MY PLAN -->
      <section id="view-plan" class="glass p-5 space-y-4 hidden text-sm">
        <h3 class="font-semibold text-slate-800 text-base">My Plan</h3>
        <p class="text-xs text-gray-500">View your active plan and subscription history.</p>

        <div class="border rounded-xl p-4 bg-white/80 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <p class="text-xs text-gray-500 mb-1">Active Plan</p>
            <p id="planViewName" class="font-semibold text-sm">No active plan</p>
            <p id="planViewMeta" class="text-xs text-gray-500 mt-1"></p>
            <p id="planViewDates" class="text-xs text-gray-500 mt-1"></p>
          </div>

          <div class="flex flex-wrap gap-2 text-xs">
            <button id="planPauseBtn" class="px-3 py-1.5 rounded-full border">Pause</button>
            <button id="planResumeBtn" class="px-3 py-1.5 rounded-full border">Resume</button>
            <button id="planCancelBtn" class="px-3 py-1.5 rounded-full border text-red-600 border-red-300">Cancel</button>
            <button id="planRenewBtn" class="px-3 py-1.5 rounded-full border">Renew</button>
            <a href="plans.html" class="px-3 py-1.5 rounded-full border">Change Plan</a>
          </div>
        </div>

        <!-- HISTORY -->
        <div class="border rounded-xl p-4 bg-white/80">
          <p class="font-semibold text-sm mb-2">Subscription History</p>

          <div class="overflow-x-auto">
            <table class="min-w-full text-xs">
              <thead>
                <tr class="text-left text-gray-500 border-b">
                  <th class="py-2 pr-4">Plan</th>
                  <th class="py-2 pr-4">Start</th>
                  <th class="py-2 pr-4">End</th>
                  <th class="py-2 pr-4">Status</th>
                </tr>
              </thead>
              <tbody id="subHistoryBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- DELIVERIES -->
      <section id="view-deliveries" class="glass p-5 space-y-4 hidden text-sm">
        <h3 class="font-semibold text-slate-800 text-base">Deliveries</h3>
        <p class="text-xs text-gray-500">Upcoming schedule and past deliveries.</p>

        <div class="border rounded-xl p-4 bg-white/80">
          <p class="font-semibold text-sm mb-2">Upcoming (next 7 days)</p>
          <ul id="delUpcomingList" class="space-y-1 text-xs text-gray-700">
            <li class="text-gray-400">Loading...</li>
          </ul>
        </div>

        <div class="border rounded-xl p-4 bg-white/80">
          <p class="font-semibold text-sm mb-2">Past Deliveries</p>
          <div class="overflow-x-auto">
            <table class="min-w-full text-xs">
              <thead>
                <tr class="text-left text-gray-500 border-b">
                  <th class="py-2 pr-4">Date</th>
                  <th class="py-2 pr-4">Status</th>
                  <th class="py-2 pr-4">Notes</th>
                </tr>
              </thead>
              <tbody id="deliveryHistoryBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PAYMENTS -->
      <section id="view-payments" class="glass p-5 space-y-4 hidden text-sm">
        <h3 class="font-semibold text-slate-800 text-base">Payments</h3>
        <p class="text-xs text-gray-500">All your payments and invoices.</p>

        <button id="downloadLastInvoiceBtn"
                class="px-3 py-1.5 rounded-full border text-xs">
          Download last invoice
        </button>

        <div class="border rounded-xl p-4 bg-white/80">
          <div class="overflow-x-auto">
            <table class="min-w-full text-xs">
              <thead>
                <tr class="text-left text-gray-500 border-b">
                  <th class="py-2 pr-4">Date</th>
                  <th class="py-2 pr-4">Plan</th>
                  <th class="py-2 pr-4">Amount</th>
                  <th class="py-2 pr-4">Method</th>
                  <th class="py-2 pr-4">Status</th>
                </tr>
              </thead>
              <tbody id="paymentHistoryBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="view-profile" class="glass p-5 space-y-4 hidden text-sm">
        <h3 class="font-semibold text-slate-800 text-base">Profile & Address</h3>
        <p class="text-xs text-gray-500">Update your basic details and delivery address.</p>

        <form id="profileForm" class="space-y-4">

          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-semibold">Full Name *</label>
              <input id="pfFullName" type="text" required class="w-full px-3 py-2 border rounded-md bg-white/80">
            </div>
            <div>
              <label class="block text-xs font-semibold">Email *</label>
              <input id="pfEmail" type="email" disabled class="w-full px-3 py-2 border rounded-md bg-gray-100">
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-semibold">Phone *</label>
              <input id="pfPhone" type="tel" required class="w-full px-3 py-2 border rounded-md bg-white/80">
            </div>
            <div>
              <label class="block text-xs font-semibold">User Type</label>
              <select id="pfUserType" class="w-full px-3 py-2 border rounded-md bg-white/80">
                <option value="">Customer</option>
                <option value="home">Home</option>
                <option value="office">Office</option>
                <option value="corporate">Corporate</option>
              </select>
            </div>
          </div>

          <!-- ADDRESS -->
          <div class="border-t pt-3">
            <label class="block text-xs font-semibold mb-2">Primary Delivery Address</label>

            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-medium">House *</label>
                <input id="pfHouse" type="text" required class="w-full px-3 py-2 border rounded bg-white/80">
              </div>
              <div>
                <label class="block text-xs font-medium">Street *</label>
                <input id="pfStreet" type="text" required class="w-full px-3 py-2 border rounded bg-white/80">
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4 mt-3">
              <div>
                <label class="block text-xs font-medium">Area *</label>
                <input id="pfArea" type="text" required class="w-full px-3 py-2 border rounded bg-white/80">
              </div>
              <div>
                <label class="block text-xs font-medium">City *</label>
                <input id="pfCity" type="text" required class="w-full px-3 py-2 border rounded bg-white/80">
              </div>
            </div>

            <div class="mt-3 max-w-xs">
              <label class="block text-xs font-medium">Pincode *</label>
              <input id="pfPincode" type="text" required class="w-full px-3 py-2 border rounded bg-white/80">
            </div>
          </div>

          <div class="border-t pt-3 space-y-2">
            <label class="text-xs font-semibold">Preferred Delivery Time</label>
            <select id="pfDeliveryTime" class="w-full md:w-60 px-3 py-2 border rounded bg-white/80 text-sm">
              <option value="">Select...</option>
              <option value="morning">Morning (6:30–9)</option>
              <option value="afternoon">Afternoon</option>
              <option value="evening">Evening</option>
            </select>

            <label class="flex items-center gap-2 text-xs">
              <input id="pfOffersOptIn" type="checkbox">
              Receive deals & updates
            </label>
          </div>

          <button type="submit"
                  class="px-6 py-2.5 rounded-full text-white text-sm font-semibold"
                  style="background:linear-gradient(90deg,#06b6d4,#7c3aed);">
            Save Profile
          </button>
        </form>
      </section>

    </div>

  </main>
</div>

<!-- FOOTER -->
<footer class="mt-8 pb-6 text-center text-[11px] text-gray-400">
  © 2025 Daily Fruit Co. — Freshness Delivered Daily
</footer>
<script>
/* ================================
   CONFIG
================================ */
const API_BASE = "https://dailyfruit-backend.onrender.com";

/* ================================
   TOAST
================================ */
function toast(msg, isError=false){
  const div = document.createElement("div");
  div.textContent = msg;
  div.className =
    "fixed bottom-4 right-4 px-3 py-2 rounded text-white text-sm shadow " +
    (isError ? "bg-red-600" : "bg-black");
  document.body.appendChild(div);
  setTimeout(()=> div.remove(), 2600);
}

/* ================================
   SESSION MANAGEMENT
================================ */
function getSession(){
  const token = localStorage.getItem("df_user_token");
  const expiry = Number(localStorage.getItem("df_session_expiry") || 0);

  if(!token || !expiry) return null;
  if(Date.now() > expiry) return null;

  return { token, expiry };
}

function requireLogin(){
  const session = getSession();
  if(!session){
    window.location.href = "login.html?redirect=dashboard.html";
    return null;
  }
  return session.token;
}

function logout(){
  localStorage.removeItem("df_user_token");
  localStorage.removeItem("df_session_expiry");
  localStorage.removeItem("df_user_profile");
  window.location.href = "login.html";
}

/* ================================
   GLOBAL STATE
================================ */
let gProfile = null;
let gActiveSub = null;
let gSubHistory = [];
let gUpcomingDeliveries = [];
let gDeliveryHistory = [];
let gPaymentHistory = [];

/* ================================
   PAGE LOAD (LOGIN CHECK)
================================ */
document.addEventListener("DOMContentLoaded", async () => {

  const token = requireLogin();
  if(!token) return;

  initSidebar();
  initLogout();
  initProfileForm();
  initQuickActions();

  await loadAllData(token);
});

/* ================================
   SIDEBAR + VIEW HANDLING
================================ */
function initSidebar(){
  document.querySelectorAll(".sidebar-link[data-view]").forEach(btn => {
    btn.onclick = () => showView(btn.dataset.view);
  });

  document.getElementById("goToPlanFromCard").onclick = () => showView("plan");
  document.getElementById("dashViewDeliveriesBtn").onclick = () => showView("deliveries");
  document.getElementById("dashViewPaymentsBtn").onclick = () => showView("payments");
  document.getElementById("qaProfile").onclick = () => showView("profile");
}

function showView(v){
  document.querySelectorAll('[id^="view-"]').forEach(sec => sec.classList.add("hidden"));
  document.getElementById("view-" + v).classList.remove("hidden");

  document.querySelectorAll(".sidebar-link").forEach(b => {
    b.classList.remove("active");
    if(b.dataset.view === v) b.classList.add("active");
  });
}

/* ================================
   LOGOUT
================================ */
function initLogout(){
  document.getElementById("logoutBtn").onclick = () => {
    if(confirm("Logout from your account?")){
      logout();
    }
  };
}

/* ================================
   LOAD ALL DATA
================================ */
async function loadAllData(token){
  try {
    await Promise.all([
      loadProfile(token),
      loadActiveSubscription(token),
      loadSubscriptionHistory(token),
      loadUpcomingDeliveries(token),
      loadDeliveryHistory(token),
      loadPaymentHistory(token)
    ]);

    renderHeader();
    renderDashboardCards();
    renderPlanView();
    renderSubHistory();
    renderDeliveryCalendar();
    renderDeliveriesView();
    renderPaymentsView();
    fillProfileForm();

  } catch (e){
    toast("Error loading dashboard", true);
  }
}

/* ================================
   LOAD PROFILE
================================ */
async function loadProfile(token){
  const res = await fetch(API_BASE + "/api/profile/me", {
    headers: { Authorization: "Bearer " + token }
  });

  if(res.status === 401){
    return requireLogin();
  }

  const u = await res.json();

  gProfile = u;
  localStorage.setItem("df_user_profile", JSON.stringify(u));
}

/* ================================
   LOAD ACTIVE SUBSCRIPTION
================================ */
async function loadActiveSubscription(token){
  const res = await fetch(API_BASE + "/api/subscriptions/my-active", {
    headers: { Authorization: "Bearer " + token }
  });
  gActiveSub = await res.json().catch(()=> null);
}

/* ================================
   LOAD HISTORY + DELIVERIES + PAYMENTS
================================ */
async function loadSubscriptionHistory(token){
  const r = await fetch(API_BASE + "/api/subscriptions/me", {
    headers: { Authorization: "Bearer " + token }
  });
  gSubHistory = await r.json().catch(()=> []);
}

async function loadUpcomingDeliveries(token){
  const r = await fetch(API_BASE + "/api/deliveries/upcoming", {
    headers: { Authorization: "Bearer " + token }
  });
  gUpcomingDeliveries = await r.json().catch(()=> []);
}

async function loadDeliveryHistory(token){
  const r = await fetch(API_BASE + "/api/deliveries/history", {
    headers: { Authorization: "Bearer " + token }
  });
  gDeliveryHistory = await r.json().catch(()=> []);
}

async function loadPaymentHistory(token){
  const r = await fetch(API_BASE + "/api/payments/my-payments", {
    headers: { Authorization: "Bearer " + token }
  });
  gPaymentHistory = await r.json().catch(()=> []);
}

/* ================================
   RENDER HEADER
================================ */
function renderHeader(){
  if(!gProfile) return;
  document.getElementById("sidebarUserName").textContent =
    gProfile.name || "User";
  document.getElementById("hdrUserEmail").textContent =
    gProfile.email || "-";
}

/* ================================
   RENDER DASHBOARD CARDS
================================ */
function renderDashboardCards(){
  const planName = document.getElementById("dashPlanName");
  const planMeta = document.getElementById("dashPlanMeta");
  const statusPill = document.getElementById("dashPlanStatusPill");

  if(!gActiveSub || !gActiveSub._id){
    planName.textContent = "No active plan";
    planMeta.textContent = "Start a subscription from the plans page.";
    statusPill.classList.add("hidden");
  } else {
    planName.textContent = gActiveSub.planName;
    planMeta.textContent = `Status: ${gActiveSub.status}`;
    statusPill.textContent = gActiveSub.status;
    statusPill.classList.remove("hidden");
  }

  // Next delivery
  const next = gUpcomingDeliveries[0];
  const nextEl = document.getElementById("dashNextDelivery");
  const nextMetaEl = document.getElementById("dashNextDeliveryMeta");

  if(next){
    nextEl.textContent = new Date(next.deliveryDate).toDateString();
    nextMetaEl.textContent = next.status;
  } else {
    nextEl.textContent = "No upcoming delivery";
  }

  // Last payment
  const last = gPaymentHistory[0];
  const lastPay = document.getElementById("dashLastPayment");
  const payMeta = document.getElementById("dashPaymentMeta");

  if(last){
    lastPay.textContent = "₹" + last.amount;
    payMeta.textContent = last.planName;
  } else {
    lastPay.textContent = "No payments yet";
  }
}

/* ================================
   PLAN VIEW
================================ */
function renderPlanView(){
  const name = document.getElementById("planViewName");
  const meta = document.getElementById("planViewMeta");
  const dates = document.getElementById("planViewDates");

  if(!gActiveSub){
    name.textContent = "No active plan";
    return;
  }

  name.textContent = gActiveSub.planName;
  meta.textContent = "Status: " + gActiveSub.status;

  const s = new Date(gActiveSub.startDate).toLocaleDateString("en-IN");
  const e = new Date(gActiveSub.endDate).toLocaleDateString("en-IN");

  dates.textContent = `From ${s} to ${e}`;
}

/* ================================
   SUB HISTORY
================================ */
function renderSubHistory(){
  const body = document.getElementById("subHistoryBody");
  body.innerHTML = "";

  gSubHistory.forEach(sub => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="py-2 pr-4">${sub.planName}</td>
      <td class="py-2 pr-4">${new Date(sub.startDate).toLocaleDateString("en-IN")}</td>
      <td class="py-2 pr-4">${new Date(sub.endDate).toLocaleDateString("en-IN")}</td>
      <td class="py-2 pr-4 capitalize">${sub.status}</td>
    `;
    body.appendChild(tr);
  });
}

/* ================================
   DELIVERY CALENDAR
================================ */
function renderDeliveryCalendar(){
  const list = document.getElementById("deliveryCalendarList");
  list.innerHTML = "";

  if(gUpcomingDeliveries.length === 0){
    list.innerHTML = `<li class="text-gray-400">No deliveries scheduled.</li>`;
    return;
  }

  gUpcomingDeliveries.forEach(del => {
    const li = document.createElement("li");
    li.className = "flex justify-between py-1 text-xs";
    li.innerHTML = `
      <span>${new Date(del.deliveryDate).toDateString()}</span>
      <button onclick="skipDelivery('${del._id}')" class="text-red-600 text-[11px]">Skip</button>
    `;
    list.appendChild(li);
  });
}

/* ================================
   FULL DELIVERY VIEW
================================ */
function renderDeliveriesView(){
  const up = document.getElementById("delUpcomingList");
  up.innerHTML = "";

  gUpcomingDeliveries.forEach(del => {
    const li = document.createElement("li");
    li.className = "flex justify-between py-1 text-xs";
    li.innerHTML = `
      <span>${new Date(del.deliveryDate).toDateString()}</span>
      <button onclick="skipDelivery('${del._id}')" class="text-red-600 text-[11px]">Skip</button>
    `;
    up.appendChild(li);
  });

  const hist = document.getElementById("deliveryHistoryBody");
  hist.innerHTML = "";

  gDeliveryHistory.forEach(d => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="py-2 pr-4">${new Date(d.deliveryDate).toLocaleDateString("en-IN")}</td>
      <td class="py-2 pr-4">${d.status}</td>
      <td class="py-2 pr-4">${d.notes || "-"}</td>
    `;
    hist.appendChild(tr);
  });
}

/* ================================
   PAYMENTS VIEW
================================ */
function renderPaymentsView(){
  const body = document.getElementById("paymentHistoryBody");
  body.innerHTML = "";

  gPaymentHistory.forEach(p => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="py-2 pr-4">${new Date(p.createdAt).toLocaleDateString("en-IN")}</td>
      <td class="py-2 pr-4">${p.planName}</td>
      <td class="py-2 pr-4">₹${p.amount}</td>
      <td class="py-2 pr-4">${p.razorpayPaymentId ? "Razorpay" : "Offline"}</td>
      <td class="py-2 pr-4">${p.status}</td>
    `;
    body.appendChild(tr);
  });
}

/* ================================
   SKIP DELIVERY
================================ */
async function skipDelivery(id){
  const session = getSession();
  if(!session) return requireLogin();

  const r = await fetch(API_BASE + "/api/deliveries/skip/" + id, {
    method: "POST",
    headers: { Authorization: "Bearer " + session.token }
  });

  const d = await r.json();
  toast(d.message || "Updated");

  await loadUpcomingDeliveries(session.token);
  await loadDeliveryHistory(session.token);

  renderDeliveryCalendar();
  renderDeliveriesView();
}
window.skipDelivery = skipDelivery;

/* ================================
   QUICK ACTIONS
================================ */
function initQuickActions(){
  const session = getSession();
  if(!session) return;
  const token = session.token;

  document.getElementById("qaPause").onclick =
    () => subAction("pause", token);
  document.getElementById("qaResume").onclick =
    () => subAction("resume", token);
  document.getElementById("qaCancel").onclick =
    () => subAction("cancel", token);
  document.getElementById("qaRenew").onclick =
    () => subAction("renew", token);

  document.getElementById("planPauseBtn").onclick =
    () => subAction("pause", token);
  document.getElementById("planResumeBtn").onclick =
    () => subAction("resume", token);
  document.getElementById("planCancelBtn").onclick =
    () => subAction("cancel", token);
  document.getElementById("planRenewBtn").onclick =
    () => subAction("renew", token);
}

async function subAction(type, token){
  if(!gActiveSub){
    toast("No active subscription", true);
    return;
  }

  const r = await fetch(API_BASE + "/api/subscriptions/" + gActiveSub._id + "/" + type, {
    method: "POST",
    headers: { Authorization: "Bearer " + token }
  });

  const d = await r.json();
  toast(d.message || "Updated");

  await loadActiveSubscription(token);
  await loadUpcomingDeliveries(token);
  await loadDeliveryHistory(token);

  renderDashboardCards();
  renderPlanView();
  renderDeliveryCalendar();
  renderDeliveriesView();
}

/* ================================
   PROFILE FORM
================================ */
function initProfileForm(){
  const form = document.getElementById("profileForm");
  if(!form) return;
  form.onsubmit = submitProfile;
}

function fillProfileForm(){
  if(!gProfile) return;

  document.getElementById("pfFullName").value = gProfile.name || "";
  document.getElementById("pfEmail").value = gProfile.email || "";
  document.getElementById("pfPhone").value = gProfile.phone || "";

  document.getElementById("pfUserType").value = gProfile.userType || "";
  document.getElementById("pfHouse").value = gProfile.addressDetails?.house || "";
  document.getElementById("pfStreet").value = gProfile.addressDetails?.street || "";
  document.getElementById("pfArea").value = gProfile.addressDetails?.area || "";
  document.getElementById("pfCity").value = gProfile.addressDetails?.city || "";
  document.getElementById("pfPincode").value = gProfile.addressDetails?.pincode || "";
  document.getElementById("pfDeliveryTime").value = gProfile.deliveryTime || "";
  document.getElementById("pfOffersOptIn").checked = gProfile.offersOptIn;
}

async function submitProfile(e){
  e.preventDefault();

  const session = getSession();
  if(!session) return requireLogin();

  const payload = {
    fullName: document.getElementById("pfFullName").value,
    phone: document.getElementById("pfPhone").value,
    userType: document.getElementById("pfUserType").value,
    offersOptIn: document.getElementById("pfOffersOptIn").checked,
    deliveryTime: document.getElementById("pfDeliveryTime").value,
    addressDetails: {
      house: document.getElementById("pfHouse").value,
      street: document.getElementById("pfStreet").value,
      area: document.getElementById("pfArea").value,
      city: document.getElementById("pfCity").value,
      pincode: document.getElementById("pfPincode").value
    }
  };

  const r = await fetch(API_BASE + "/api/profile/update", {
    method: "POST",
    headers:{
      "Content-Type": "application/json",
      Authorization: "Bearer " + session.token
    },
    body: JSON.stringify(payload)
  });

  const d = await r.json();
  toast(d.message || "Profile Updated");

  await loadProfile(session.token);
  renderHeader();
}
</script>
