<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout — Daily Fruit Co.</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://kit.fontawesome.com/0c9b1f3f2d.js" crossorigin="anonymous"></script>

<style>
  body {font-family:'Inter',sans-serif;background:linear-gradient(180deg,#f8fafc,#eef7ff);}
  .glass{background:rgba(255,255,255,0.9);backdrop-filter:blur(12px);border-radius:18px;border:1px solid rgba(148,163,184,0.4);box-shadow:0 10px 30px rgba(15,23,42,0.12);}
  .section-title{background:linear-gradient(90deg,#06b6d4,#7c3aed);-webkit-background-clip:text;color:transparent;font-weight:800;}
  .btn-grad{background:linear-gradient(90deg,#06b6d4,#7c3aed);color:#fff;}
</style>
</head>

<body>

<!-- HEADER -->
<header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b">
  <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
    <a href="index.html" class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-teal-400 text-white flex items-center justify-center font-bold shadow">DF</div>
      <div>
        <h1 class="text-lg font-semibold">Daily Fruit Co.</h1>
        <p class="text-xs text-gray-500">Freshness Delivered Daily</p>
      </div>
    </a>
  </div>
</header>

<!-- MAIN -->
<main class="max-w-4xl mx-auto px-4 py-8">

  <h2 class="text-3xl md:text-4xl font-extrabold section-title mb-2">Checkout</h2>
  <p class="text-gray-600 text-sm md:text-base mb-6">Review your plan, apply coupon and confirm your order.</p>

  <div class="glass p-5 md:p-6 grid md:grid-cols-2 gap-6">
    
    <!-- LEFT SIDE — ORDER SUMMARY -->
    <section>
      <h3 class="font-semibold text-lg mb-2 flex items-center gap-2">
        <i class="fa fa-receipt text-emerald-500"></i> Order Summary
      </h3>

      <!-- Loaded from localStorage -->
      <div class="border border-gray-200 rounded-lg p-3 mb-3 text-sm">
        <p class="font-semibold" id="planName">Plan name</p>
        <p class="text-xs text-gray-500" id="planMeta">—</p>
      </div>

      <!-- Prices -->
      <div class="mt-3 space-y-1 text-sm">
        <div class="flex justify-between">
          <span>Base price</span>
          <span id="basePrice">₹0</span>
        </div>

        <div class="flex justify-between text-emerald-600">
          <span>Discount</span>
          <span id="discountAmount">- ₹0</span>
        </div>

        <div class="flex justify-between font-semibold text-lg mt-2 border-t pt-2">
          <span>Total</span>
          <span id="totalAmount">₹0</span>
        </div>

        <p class="text-[11px] text-gray-500 mt-1">
          Payment via UPI / Cash-on-delivery (Confirmed on WhatsApp).
        </p>
      </div>

      <!-- Coupons -->
      <div class="mt-4">
        <label class="block text-xs font-semibold text-gray-600 mb-1">Coupon code</label>
        <div class="flex gap-2">
          <input id="couponInput" type="text" placeholder="e.g. FRUIT10" class="flex-1 px-3 py-2 border rounded text-sm">
          <button id="applyCouponBtn" type="button" class="px-3 py-2 rounded text-xs border border-emerald-500 text-emerald-700">Apply</button>
        </div>

        <p class="text-[11px] text-gray-500 mt-1">
          Available: <b>FRUIT10</b> (10% off), <b>FIRST100</b> (₹100 off first order)
        </p>

        <p id="couponMsg" class="text-[11px] mt-1 text-gray-500"></p>
      </div>
    </section>


    <!-- RIGHT SIDE — ADDRESS -->
    <section>
      <h3 class="font-semibold text-lg mb-2 flex items-center gap-2">
        <i class="fa fa-location-dot text-emerald-500"></i> Delivery Details
      </h3>

      <form id="checkoutForm" class="space-y-3 text-sm">

        <div>
          <label class="block text-xs font-medium text-gray-600 mb-1">Full Name</label>
          <input id="fullName" type="text" class="w-full px-3 py-2 border rounded" placeholder="Your name">
        </div>

        <div>
          <label class="block text-xs font-medium text-gray-600 mb-1">Address Line</label>
          <input id="addrLine1" type="text" class="w-full px-3 py-2 border rounded" placeholder="Flat / building / street">
        </div>

        <div>
          <label class="block text-xs font-medium text-gray-600 mb-1">Area / Locality</label>
          <input id="addrArea" type="text" class="w-full px-3 py-2 border rounded" placeholder="Area / landmark">
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">City</label>
            <input id="addrCity" type="text" class="w-full px-3 py-2 border rounded" placeholder="Pune">
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Pincode</label>
            <input id="addrPincode" type="text" class="w-full px-3 py-2 border rounded" placeholder="411001">
          </div>
        </div>

        <p class="text-[11px] text-gray-500">
          Deliveries between <b>6:30 AM – 10:00 AM</b>. We confirm exact slot on WhatsApp.
        </p>

        <button type="submit"
          class="w-full mt-2 py-2.5 rounded-full btn-grad font-semibold text-sm flex items-center justify-center gap-2">
          <span>Place Order & Confirm on WhatsApp</span>
          <i class="fa fa-arrow-right"></i>
        </button>

        <p id="checkoutMsg" class="text-[11px] text-center mt-2 text-gray-500"></p>

      </form>
    </section>
  </div>

</main>

<script>
const API_BASE = "http://localhost:4000";

let selectedPlan = null;
let basePrice = 0;
let discount = 0;
let appliedCoupon = null;

function INR(v) { return "₹" + (v || 0); }

function loadPlan() {
  const raw = localStorage.getItem("df_selected_plan");
  if (!raw) return;

  selectedPlan = JSON.parse(raw);
  basePrice = selectedPlan.price;

  document.getElementById("planName").textContent = selectedPlan.name;
  document.getElementById("planMeta").textContent = selectedPlan.slug + " • " + INR(basePrice);
  updateTotals();
}

function updateTotals() {
  document.getElementById("basePrice").textContent = INR(basePrice);
  document.getElementById("discountAmount").textContent = "- " + INR(discount);
  document.getElementById("totalAmount").textContent = INR(basePrice - discount);
}

document.getElementById("applyCouponBtn").addEventListener("click", () => {
  const input = document.getElementById("couponInput").value.trim().toUpperCase();
  const msg = document.getElementById("couponMsg");

  discount = 0;
  appliedCoupon = null;

  if (input === "FRUIT10") {
    discount = Math.round(basePrice * 0.10);
    appliedCoupon = "FRUIT10";
    msg.textContent = "Coupon applied — 10% off!";
    msg.className = "text-[11px] text-emerald-600 mt-1";
  } else if (input === "FIRST100") {
    discount = 100;
    appliedCoupon = "FIRST100";
    msg.textContent = "₹100 off applied!";
    msg.className = "text-[11px] text-emerald-600 mt-1";
  } else {
    msg.textContent = "Invalid coupon code.";
    msg.className = "text-[11px] text-red-600 mt-1";
  }

  updateTotals();
});

document.getElementById("checkoutForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const msg = document.getElementById("checkoutMsg");

  const token = localStorage.getItem("df_token");
  if (!token) return (window.location = "login.html");

  const payload = {
    planSlug: selectedPlan.slug,
    couponCode: appliedCoupon,
    address: {
      line1: addrLine1.value,
      area: addrArea.value,
      city: addrCity.value,
      pincode: addrPincode.value
    },
    name: fullName.value.trim()
  };

  try {
    const res = await fetch(API_BASE + "/api/checkout/place", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + token
      },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (!data.success) throw new Error(data.message);

    msg.textContent = "Order placed! Redirecting to WhatsApp…";
    msg.className = "text-[11px] text-emerald-600 text-center mt-2";

    const waText =
      `Hi Daily Fruit Co,\n\n` +
      `I just placed a new subscription.\n\n` +
      `Name: ${payload.name}\n` +
      `Plan: ${selectedPlan.name}\n` +
      `Total: ₹${basePrice - discount}\n` +
      `Coupon: ${appliedCoupon || "None"}\n\n` +
      `Address:\n${payload.address.line1}, ${payload.address.area}, ${payload.address.city} - ${payload.address.pincode}`;

    window.open("https://wa.me/919226157351?text=" + encodeURIComponent(waText), "_blank");

    setTimeout(() => (window.location = "dashboard.html"), 1200);

  } catch (err) {
    msg.textContent = err.message;
    msg.className = "text-[11px] text-red-600 text-center mt-2";
  }
});

loadPlan();
</script>
</body>
</html>
