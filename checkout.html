<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout â€” Daily Fruit Co.</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Inter',sans-serif;
  background:linear-gradient(180deg,#f8fafc,#eef7ff);
}
.glass{
  background:rgba(255,255,255,0.9);
  backdrop-filter:blur(12px);
  border-radius:18px;
  border:1px solid rgba(148,163,184,0.4);
  box-shadow:0 10px 30px rgba(15,23,42,0.12);
}
.section-title{
  background:linear-gradient(90deg,#06b6d4,#7c3aed);
  -webkit-background-clip:text;
  color:transparent;
  font-weight:800;
}
.button-press{
  transition:transform .1s ease, box-shadow .1s ease;
}
.button-press:active{
  transform:scale(.96);
  box-shadow:inset 0 4px 10px rgba(0,0,0,.15);
}

/* Coupon polish */
.coupon-success{ color:#059669; font-weight:600 }
.coupon-error{ color:#dc2626; font-weight:600 }
.coupon-loading{ opacity:.6; pointer-events:none }
.coupon-applied{ background:#ecfdf5; border:1px solid #10b981 }
</style>
</head>

<body>

<script>
const API_BASE = "https://dailyfruit-backend.onrender.com";
const token = localStorage.getItem("df_user_token");
if (!token) location.href = "login.html?redirect=checkout.html";
</script>

<section class="max-w-6xl mx-auto px-4 py-10">
<h2 class="text-4xl text-center section-title mb-6">Checkout</h2>

<div class="glass p-6 md:p-8 grid md:grid-cols-3 gap-8">

<!-- LEFT -->
<div class="md:col-span-2 space-y-4">

<h3 class="text-xl font-bold">Delivery & Contact</h3>

<div class="grid md:grid-cols-2 gap-4">
  <input id="fullName" placeholder="Full Name" class="border rounded px-3 py-2">
  <input id="email" disabled class="border rounded px-3 py-2 bg-gray-100">
</div>

<input id="phone" disabled class="border rounded px-3 py-2 bg-gray-100">

<div>
  <label class="text-sm font-semibold">Select Address</label>
  <select id="addressSelect" class="border rounded px-3 py-2 w-full"></select>
</div>

<div class="grid md:grid-cols-2 gap-4">
  <input id="house" placeholder="House / Flat" class="border rounded px-3 py-2">
  <input id="street" placeholder="Street" class="border rounded px-3 py-2">
</div>

<div class="grid md:grid-cols-2 gap-4">
  <input id="area" placeholder="Area" class="border rounded px-3 py-2">
  <input id="city" placeholder="City" class="border rounded px-3 py-2">
</div>

<input id="pincode" placeholder="Pincode" maxlength="6" class="border rounded px-3 py-2">

<div class="flex gap-3">
  <select id="addressLabel" class="border rounded px-3 py-2">
    <option>Home</option>
    <option>Office</option>
    <option>Other</option>
  </select>

  <button onclick="saveNewAddress()"
    class="button-press px-4 py-2 rounded text-white font-semibold"
    style="background:linear-gradient(90deg,#06b6d4,#7c3aed)">
    Save Address
  </button>
</div>

<button id="payBtn"
  class="button-press mt-4 px-6 py-3 rounded-full text-white font-bold w-full"
  style="background:linear-gradient(90deg,#06b6d4,#7c3aed)">
  Pay Now
</button>

</div>

<!-- RIGHT -->
<div class="space-y-4">

<div class="glass p-4">
  <h3 class="font-bold">Selected Plan</h3>
  <p id="planName"></p>
  <p id="planPrice" class="font-bold text-emerald-600"></p>
</div>

<div class="glass p-4 text-sm">
  <h4 class="font-semibold mb-2">Price Details</h4>

  <div id="discountRow" class="flex justify-between text-emerald-600 font-semibold hidden">
    <span>Discount</span>
    <span id="discountText"></span>
  </div>

  <div class="flex justify-between font-bold mt-2">
    <span>Total</span>
    <span id="totalText"></span>
  </div>

  <p id="savingText" class="text-xs text-emerald-600 mt-1 hidden"></p>
</div>

<!-- COUPON -->
<div class="glass p-4 text-sm">
  <h4 class="font-semibold mb-2">Apply Coupon</h4>
  <div class="flex gap-2">
    <input id="couponInput"
      class="border rounded px-3 py-2 flex-1 uppercase"
      placeholder="Enter coupon code"
      oninput="this.value=this.value.toUpperCase().trim()">
    <button onclick="applyCoupon()"
      class="button-press px-4 py-2 rounded text-white font-semibold"
      style="background:linear-gradient(90deg,#06b6d4,#7c3aed)">
      Apply
    </button>
  </div>

  <p id="couponMsg" class="text-xs mt-2"></p>

  <button id="removeCouponBtn"
    onclick="removeCoupon()"
    class="hidden text-xs text-red-500 underline mt-1">
    Remove coupon
  </button>
</div>

</div>
</div>
</section>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
let PLAN = JSON.parse(localStorage.getItem("df_selected_plan"));
let appliedCoupon = null;
let addresses = [];

/* PROFILE */
async function loadProfile(){
  const r = await fetch(API_BASE+"/api/users/me",{headers:{Authorization:"Bearer "+token}});
  const u = await r.json();
  fullName.value = u.name || "";
  email.value = u.email || "";
  phone.value = u.phone || "";
}

/* ADDRESSES */
async function loadAddresses(){
  const r = await fetch(API_BASE+"/api/users/me/addresses",{headers:{Authorization:"Bearer "+token}});
  const d = await r.json();
  addresses = d.addresses || [];
  addressSelect.innerHTML="";
  addresses.forEach((a,i)=>{
    const o=document.createElement("option");
    o.value=i;
    o.textContent=`${a.label} â€” ${a.area}, ${a.city}`;
    if(a.isDefault) o.selected=true;
    addressSelect.appendChild(o);
  });
  if(addresses.length) fillAddress(addressSelect.value);
}

function fillAddress(i){
  const a = addresses[i];
  house.value=a.house;
  street.value=a.street;
  area.value=a.area;
  city.value=a.city;
  pincode.value=a.pincode;
}

async function saveNewAddress(){
  await fetch(API_BASE+"/api/users/me/addresses",{
    method:"POST",
    headers:{ "Content-Type":"application/json", Authorization:"Bearer "+token },
    body:JSON.stringify({
      label:addressLabel.value,
      house:house.value,
      street:street.value,
      area:area.value,
      city:city.value,
      pincode:pincode.value,
      isDefault:true
    })
  });
  loadAddresses();
}

/* COUPON */
async function applyCoupon(){
  if(!couponInput.value){
    couponMsg.textContent="Please enter a coupon code";
    couponMsg.className="text-xs mt-2 coupon-error";
    return;
  }

  couponInput.classList.add("coupon-loading");
  couponMsg.textContent="Checking coupon...";
  couponMsg.className="text-xs mt-2";

  const r = await fetch(API_BASE+"/api/coupons/apply",{
    method:"POST",
    headers:{ "Content-Type":"application/json", Authorization:"Bearer "+token },
    body:JSON.stringify({
      code:couponInput.value,
      amount:PLAN.price,
      planId:PLAN._id
    })
  });

  const d = await r.json();
  couponInput.classList.remove("coupon-loading");

  if(!r.ok){
    couponMsg.textContent=d.message || "Invalid coupon";
    couponMsg.className="text-xs mt-2 coupon-error";
    return;
  }

  appliedCoupon=d.code;
  discountRow.classList.remove("hidden");
  discountText.textContent="- â‚¹"+d.discount;
  totalText.textContent="â‚¹"+d.finalAmount;

  savingText.textContent=`You saved â‚¹${d.discount} ðŸŽ‰`;
  savingText.classList.remove("hidden");

  couponMsg.textContent="Coupon applied successfully";
  couponMsg.className="text-xs mt-2 coupon-success";

  couponInput.disabled=true;
  couponInput.classList.add("coupon-applied");
  removeCouponBtn.classList.remove("hidden");
}

function removeCoupon(){
  appliedCoupon=null;
  discountRow.classList.add("hidden");
  savingText.classList.add("hidden");
  totalText.textContent="â‚¹"+PLAN.price;
  couponInput.disabled=false;
  couponInput.value="";
  couponInput.classList.remove("coupon-applied");
  couponMsg.textContent="Coupon removed";
  couponMsg.className="text-xs mt-2";
  removeCouponBtn.classList.add("hidden");
}

/* PAY */
payBtn.onclick=async()=>{
  payBtn.disabled=true;
  payBtn.textContent="Processing...";
  const r=await fetch(API_BASE+"/api/payments/create-order",{
    method:"POST",
    headers:{ "Content-Type":"application/json", Authorization:"Bearer "+token },
    body:JSON.stringify({ planSlug:PLAN.slug, couponCode:appliedCoupon })
  });
  const o=await r.json();

  new Razorpay({
    key:o.key,
    amount:o.amount,
    currency:"INR",
    order_id:o.orderId,
    handler:async(resp)=>{
      await fetch(API_BASE+"/api/payments/verify",{
        method:"POST",
        headers:{ "Content-Type":"application/json", Authorization:"Bearer "+token },
        body:JSON.stringify(resp)
      });
      location.href="dashboard.html";
    }
  }).open();

  payBtn.disabled=false;
  payBtn.textContent="Pay Now";
};

document.addEventListener("DOMContentLoaded",()=>{
  planName.textContent=PLAN.name;
  planPrice.textContent="â‚¹"+PLAN.price;
  totalText.textContent="â‚¹"+PLAN.price;
  loadProfile();
  loadAddresses();
  addressSelect.onchange=()=>fillAddress(addressSelect.value);
});
</script>

</body>
</html>
