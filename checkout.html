<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout — Daily Fruit Co.</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Inter',sans-serif;
  background:linear-gradient(180deg,#f8fafc,#eef7ff);
}
.glass{
  background:rgba(255,255,255,0.9);
  backdrop-filter:blur(12px);
  border-radius:18px;
  border:1px solid rgba(148,163,184,0.4);
  box-shadow:0 10px 30px rgba(15,23,42,0.12);
}
.section-title{
  background:linear-gradient(90deg,#06b6d4,#7c3aed);
  -webkit-background-clip:text;
  color:transparent;
  font-weight:800;
}
</style>
</head>

<body>

<header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b">
  <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
    <a href="index.html" class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-teal-400 text-white flex items-center justify-center font-bold shadow">DF</div>
      <div>
        <h1 class="text-lg font-semibold">Daily Fruit Co.</h1>
        <p class="text-xs text-gray-500">Freshness Delivered Daily</p>
      </div>
    </a>
  </div>
</header>

<section class="max-w-6xl mx-auto px-4 py-10">
  <h2 class="text-4xl font-extrabold text-center section-title mb-6">Checkout</h2>

  <div class="glass p-6 md:p-8 space-y-6">

    <!-- FORM -->
    <form id="checkoutForm" class="space-y-4">

      <div>
        <label class="text-sm font-medium">Full Name</label>
        <input type="text" id="fullName" required
               class="w-full border rounded-md px-3 py-2 bg-white/80">
      </div>

      <div>
        <label class="text-sm font-medium">Email</label>
        <input type="email" id="email" required
               class="w-full border rounded-md px-3 py-2 bg-white/80">
      </div>

      <div>
        <label class="text-sm font-medium">Phone</label>
        <input type="tel" id="phone" required maxlength="10"
               class="w-full border rounded-md px-3 py-2 bg-white/80">
      </div>

      <button id="payBtn"
              class="w-full px-4 py-2 rounded-full text-white text-lg font-semibold"
              style="background:linear-gradient(90deg,#06b6d4,#7c3aed);">
        Pay Now
      </button>
    </form>

    <!-- PLAN -->
    <div class="glass p-4">
      <h3 class="font-bold text-lg">Selected Plan</h3>
      <p id="planName" class="text-gray-800 font-semibold mt-1"></p>
      <p id="planPrice" class="text-emerald-600 font-bold"></p>
    </div>

  </div>
</section>


<!-- RAZORPAY JS -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
const API_BASE = "https://dailyfruit-backend.onrender.com";

// LIVE Razorpay Key ID (safe for frontend)
const RZP_KEY = "rzp_live_Rn88PMRmNfQxgk";

// ------------------------------
// Prefill USER + PLAN
// ------------------------------
const profile = JSON.parse(localStorage.getItem("df_user_profile") || "{}");
const plan = JSON.parse(localStorage.getItem("df_selected_plan") || "{}");

document.getElementById("fullName").value = profile?.fullName || "";
document.getElementById("email").value = profile?.email || "";
document.getElementById("phone").value = profile?.phone || "";

document.getElementById("planName").textContent = plan?.name || "No plan selected";
document.getElementById("planPrice").textContent = plan?.price
  ? "₹" + plan.price
  : "";

// ------------------------------
// MAIN PAYMENT START
// ------------------------------
document.getElementById("checkoutForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  if (!plan || !plan.price) {
    alert("Please select a plan first.");
    return;
  }

  // -----------------------------
  // CREATE ORDER (backend)
  // -----------------------------
  const res = await fetch(`${API_BASE}/api/payment/create-order`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + (localStorage.getItem("df_user_token") || "")
    },
    body: JSON.stringify({
      amount: plan.price,
      planSlug: plan.slug
    })
  });

  const order = await res.json();
  if (!res.ok) {
    alert(order.message || "Could not create order");
    return;
  }

  // -----------------------------
  // OPEN RAZORPAY POPUP
  // -----------------------------
  const options = {
    key: RZP_KEY,
    amount: order.amount,
    currency: "INR",
    name: "Daily Fruit Co.",
    description: plan.name,
    order_id: order.id,

    prefill: {
      name: document.getElementById("fullName").value,
      email: document.getElementById("email").value,
      contact: document.getElementById("phone").value
    },

    handler: async function (response) {
      // -----------------------------
      // VERIFY PAYMENT (backend)
      // -----------------------------
      const verifyRes = await fetch(`${API_BASE}/api/payment/verify`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          razorpay_order_id: response.razorpay_order_id,
          razorpay_payment_id: response.razorpay_payment_id,
          razorpay_signature: response.razorpay_signature
        })
      });

      const verifyData = await verifyRes.json();

      if (!verifyRes.ok) {
        alert("Payment verification failed.");
        return;
      }

      alert("Payment Successful!");
      window.location.href = "dashboard.html";
    },

    theme: { color: "#06b6d4" }
  };

  const rzp = new Razorpay(options);
  rzp.open();
});
</script>

</body>
</html>
