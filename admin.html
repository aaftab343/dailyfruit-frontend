<!-- ======================================================
DAILY FRUIT CO ‚Äî ENTERPRISE ADMIN PANEL
FINAL MERGED VERSION
PART 1 / 2
====================================================== -->
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Daily Fruit Co ‚Äî Enterprise Admin</title>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<script>
tailwind.config = {
  darkMode: 'class',
  theme: {
    extend: {
      colors: {
        brand: {
          500: '#22c55e',
          600: '#16a34a',
          700: '#15803d'
        }
      },
      boxShadow: {
        glass: '0 10px 35px rgba(0,0,0,.08)'
      }
    }
  }
}
</script>

<style>
body {
  background: linear-gradient(135deg, #ecfeff, #f0fdf4);
  font-family: Inter, system-ui, -apple-system, sans-serif;
}
.glass {
  background: rgba(255,255,255,0.88);
  backdrop-filter: blur(14px);
}
.nav-btn {
  padding: .6rem .75rem;
  border-radius: .5rem;
  text-align: left;
  width: 100%;
}
.nav-btn:hover {
  background: rgba(255,255,255,.18);
}
.hidden-role {
  display: none !important;
}
</style>
</head>

<body class="h-full text-slate-800">

<div class="min-h-screen flex">

<!-- ================= SIDEBAR ================= -->
<aside class="w-72 bg-gradient-to-b from-emerald-600 to-green-500 text-white p-5 hidden md:flex flex-col">
  <div class="mb-6">
    <div class="text-xl font-bold">Daily Fruit Co</div>
    <div class="text-xs opacity-80">Enterprise Admin</div>
  </div>

  <nav class="space-y-1 text-sm flex-1">
    <button class="nav-btn" onclick="UI.show('dashboard')">üìä Dashboard</button>
    <button class="nav-btn role-manager" onclick="UI.show('users')">üë• Users</button>
    <button class="nav-btn role-manager" onclick="UI.show('plans')">üì¶ Plans</button>
    <button class="nav-btn role-manager" onclick="UI.show('orders')">üßæ Orders</button>
    <button class="nav-btn role-delivery" onclick="UI.show('delivery')">üöö Delivery</button>
    <button class="nav-btn role-manager" onclick="UI.show('payments')">üí≥ Payments</button>
    <button class="nav-btn role-manager" onclick="location.href='admin-coupons.html'">
  üéüÔ∏è Coupons
</button>
    <button class="nav-btn role-admin" onclick="UI.show('inventory')">üìâ Inventory</button>
    <button class="nav-btn role-admin" onclick="UI.show('cms')">üì∞ CMS</button>
    <button class="nav-btn role-admin" onclick="UI.show('settings')">‚öôÔ∏è Settings</button>
  </nav>

  <div class="text-xs opacity-80">
    Role: <span id="roleBadge">‚Äî</span>
  </div>
</aside>

<!-- ================= MAIN ================= -->
<div class="flex-1 flex flex-col">

<!-- HEADER -->
<header class="glass shadow-glass sticky top-0 z-30">
  <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
    <h1 id="pageTitle" class="text-xl font-semibold">Dashboard</h1>
    <button onclick="Auth.logout()" class="text-sm underline">Logout</button>
  </div>
</header>

<!-- ================= LOGIN ================= -->
<main id="loginScreen" class="flex-1 flex items-center justify-center">
  <div class="glass shadow-glass p-6 rounded-xl w-full max-w-sm">
    <h2 class="text-lg font-semibold mb-4 text-center">Admin Login</h2>

    <label class="text-xs">Email</label>
    <input id="adminEmail" class="w-full border p-2 rounded mb-3">

    <button onclick="Auth.login()" class="w-full bg-brand-600 hover:bg-brand-700 text-white py-2 rounded">
      Login
    </button>

    <p id="loginError" class="text-red-500 text-xs mt-2 hidden"></p>
  </div>
</main>

<!-- ================= DASHBOARD ================= -->
<main id="dashboard" class="hidden p-6 space-y-6 overflow-y-auto">

  <!-- METRICS -->
  <section class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <div class="glass p-4 rounded-xl shadow-glass">
      <div class="text-xs">Orders Today</div>
      <div id="d_ordersToday" class="text-2xl font-bold">0</div>
    </div>
    <div class="glass p-4 rounded-xl shadow-glass">
      <div class="text-xs">Orders This Month</div>
      <div id="d_ordersMonth" class="text-2xl font-bold">0</div>
    </div>
    <div class="glass p-4 rounded-xl shadow-glass">
      <div class="text-xs">Revenue Today</div>
      <div id="d_revenueToday" class="text-2xl font-bold">‚Çπ0</div>
    </div>
    <div class="glass p-4 rounded-xl shadow-glass">
      <div class="text-xs">Revenue This Month</div>
      <div id="d_revenueMonth" class="text-2xl font-bold">‚Çπ0</div>
    </div>
  </section>

  <!-- ALERTS -->
  <section class="glass p-4 rounded-xl shadow-glass">
    <h3 class="font-semibold mb-2">üîî Alerts</h3>
    <ul id="alertsList" class="text-sm text-red-600 space-y-1"></ul>
  </section>

  <!-- GRAPH -->
  <section class="glass p-4 rounded-xl shadow-glass">
    <h3 class="font-semibold mb-2">üìà Orders vs Revenue</h3>
    <canvas id="ordersChart" height="120"></canvas>
  </section>

</main>

<!-- ================= USERS ================= -->
<main id="users" class="hidden p-6 overflow-y-auto">
  <h2 class="text-lg font-semibold mb-4">Users</h2>

  <table class="w-full text-sm bg-white rounded-xl shadow">
    <thead class="border-b">
      <tr>
        <th class="p-2 text-left">User</th>
        <th class="p-2">Wallet</th>
        <th class="p-2">Status</th>
        <th class="p-2">Action</th>
      </tr>
    </thead>
    <tbody id="usersTable"></tbody>
  </table>
</main>

<!-- ================= PLANS ================= -->
<main id="plans" class="hidden p-6 overflow-y-auto">
  <div class="flex justify-between mb-4">
    <h2 class="text-lg font-semibold">Plans</h2>
    <button onclick="Plans.create()" class="bg-brand-600 text-white px-3 py-1 rounded text-sm">
      Add Plan
    </button>
  </div>

  <div id="plansList" class="space-y-3"></div>
</main>

<!-- ================= ORDERS (shell) ================= -->
<main id="orders" class="hidden p-6 overflow-y-auto">
  <h2 class="text-lg font-semibold mb-4">Orders</h2>
  <div id="ordersTableWrap"></div>
</main>

<!-- ================= DELIVERY (shell) ================= -->
<main id="delivery" class="hidden p-6 overflow-y-auto"></main>

<!-- ================= PAYMENTS (shell) ================= -->
<main id="payments" class="hidden p-6 overflow-y-auto"></main>

<!-- ================= INVENTORY (shell) ================= -->
<main id="inventory" class="hidden p-6 overflow-y-auto"></main>

<!-- ================= CMS (shell) ================= -->
<main id="cms" class="hidden p-6 overflow-y-auto"></main>

<!-- ================= SETTINGS (shell) ================= -->
<main id="settings" class="hidden p-6 overflow-y-auto"></main>

</div>
</div>

<script>
/* ======================================================
CONFIG + AUTH + RBAC + CORE HELPERS
====================================================== */

const API_BASE = "https://dailyfruit-backend.onrender.com";
let ADMIN_TOKEN = localStorage.getItem("admin_token");
let ADMIN_ROLE = localStorage.getItem("admin_role") || "SUPPORT";

/* ---------------- AUTH ---------------- */
const Auth = {
  async login(){
    const email = adminEmail.value.trim();
    const password = prompt("Enter admin password");
    if(!email || !password) return;

    try{
      const res = await fetch(API_BASE + "/api/admin/auth/login", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ email, password })
      });

      const data = await res.json();
      if(!res.ok) throw new Error(data.message);

      ADMIN_TOKEN = data.token;
      ADMIN_ROLE = data.admin.role;
localStorage.setItem("admin_role", ADMIN_ROLE);

      localStorage.setItem("admin_token", ADMIN_TOKEN);

      roleBadge.textContent = ADMIN_ROLE;
      RBAC.apply();

      loginScreen.classList.add("hidden");
      UI.show("dashboard");
      Dashboard.load();

    } catch(err){
      loginError.textContent = err.message;
      loginError.classList.remove("hidden");
    }
  },

  logout(){
    localStorage.removeItem("admin_token");
    location.reload();
  }
};

/* ---------------- RBAC ---------------- */
const RBAC = {
  apply(){
    if(ADMIN_ROLE !== "SUPER_ADMIN"){
      document.querySelectorAll(".role-admin").forEach(el=>el.classList.add("hidden-role"));
    }
    if(!["SUPER_ADMIN","MANAGER"].includes(ADMIN_ROLE)){
      document.querySelectorAll(".role-manager").forEach(el=>el.classList.add("hidden-role"));
    }
    if(!["SUPER_ADMIN","DELIVERY_ADMIN"].includes(ADMIN_ROLE)){
      document.querySelectorAll(".role-delivery").forEach(el=>el.classList.add("hidden-role"));
    }
  }
};

/* ---------------- UI ---------------- */
const UI = {
  show(id){
    document.querySelectorAll("main").forEach(m=>m.classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
    pageTitle.textContent = id.charAt(0).toUpperCase() + id.slice(1);
  }
};

/* ---------------- FETCH ---------------- */
/* ---------------- FETCH ---------------- */
async function authFetch(url, method = "GET", body = null) {
  if (!ADMIN_TOKEN) {
    Auth.logout();
    return [];
  }

  const res = await fetch(url, {
    method,
     cache: "no-store", // üî• IMPORTANT
    headers: {
      "Authorization": "Bearer " + ADMIN_TOKEN,
      "Content-Type": "application/json",
      "Cache-Control": "no-store"
    },
    body: body ? JSON.stringify(body) : null
  });

  if (res.status === 401) {
    Auth.logout();
    return [];
  }

  if (res.status === 304) {
    return [];
  }

  return res.json();
}


/* ======================================================
DASHBOARD MODULE
====================================================== */
const Dashboard = {
  async load(){
    const data = await authFetch(API_BASE + "/api/admin/stats");

    d_ordersToday.textContent = data.ordersToday;
    d_ordersMonth.textContent = data.ordersMonth;
    d_revenueToday.textContent = "‚Çπ" + data.revenueToday;
    d_revenueMonth.textContent = "‚Çπ" + data.revenueMonth;

    alertsList.innerHTML = "";
    data.alerts.forEach(a=>{
      alertsList.innerHTML += `<li>‚Ä¢ ${a}</li>`;
    });

    Chart.draw(data.graph);
  }
};

/* ---------------- SIMPLE CANVAS GRAPH ---------------- */
const Chart = {
  draw(points){
    const ctx = ordersChart.getContext("2d");
    ctx.clearRect(0,0,ordersChart.width,ordersChart.height);

    ctx.beginPath();
    ctx.strokeStyle = "#22c55e";
    ctx.lineWidth = 2;

    points.forEach((p,i)=>{
      const x = (i/(points.length-1))*ordersChart.width;
      const y = ordersChart.height - (p.orders*2);
      if(i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    });
    ctx.stroke();
  }
};

/* ======================================================
USERS MODULE
====================================================== */
const Users = {
  async load(){
    const users = await authFetch(API_BASE + "/api/admin/users");
    usersTable.innerHTML = "";

    users.forEach(u=>{
      usersTable.innerHTML += `
        <tr class="border-b">
          <td class="p-2">
            ${u.name}<br>
            <span class="text-xs">${u.email}</span>
          </td>
          <td class="p-2">‚Çπ${u.wallet || 0}</td>
          <td class="p-2">${u.blocked ? "Blocked" : "Active"}</td>
          <td class="p-2">
            <button onclick="Users.toggleBlock('${u._id}', ${!u.blocked})" class="text-xs underline">
              ${u.blocked ? "Unblock" : "Block"}
            </button>
          </td>
        </tr>
      `;
    });
  },

  async toggleBlock(id, blocked){
    await authFetch(API_BASE + `/api/admin/users/${id}/block`, "PATCH", { blocked });
    this.load();
  }
};

/* ======================================================
PLANS MODULE
====================================================== */
const Plans = {
  async load(){
    const plans = await authFetch(API_BASE + "/api/admin/plans");
    plansList.innerHTML = "";

    plans.forEach(p=>{
      plansList.innerHTML += `
        <div class="glass p-4 rounded-xl shadow-glass flex justify-between items-center">
          <div>
            <div class="font-semibold">
              ${p.name}
              ${p.bestSeller ? '<span class="text-green-600 text-xs ml-2">Best Seller</span>' : ''}
            </div>
            <div class="text-xs text-slate-500">
              ‚Çπ${p.price} ‚Ä¢ ${p.billingDaysPerMonth || p.durationDays || 30} days
            </div>
          </div>
          <button onclick="Plans.toggle('${p._id}')" class="text-xs underline">
            ${p.active ? "Disable" : "Enable"}
          </button>
        </div>
      `;
    });
  },

  async toggle(id){
    await authFetch(API_BASE + `/api/admin/plans/${id}/toggle`, "PATCH");
    this.load();
  },

  create(){
    alert("Plan creation modal hook ready (backend supported)");
  }
};

/* ---------------- AUTO LOGIN ---------------- */
if(ADMIN_TOKEN){
  roleBadge.textContent = ADMIN_ROLE;
  RBAC.apply();
  loginScreen.classList.add("hidden");
  UI.show("dashboard");
  Dashboard.load();
}
</script>

<!-- ======================================================
END OF PART 1 ‚Äî DO NOT CLOSE BODY / HTML
PART 2 MUST BE PASTED BELOW
====================================================== -->
<script>
/* ======================================================
ORDERS MODULE
====================================================== */
const Orders = {
  async load(){
    const orders = await authFetch(API_BASE + "/api/admin/orders");
    let html = `
      <table class="w-full bg-white rounded-xl shadow text-sm">
        <thead class="border-b">
          <tr>
            <th class="p-2 text-left">Customer</th>
            <th class="p-2">Plan</th>
<th class="p-2">Order Date</th>
<th class="p-2">Start Date</th>
<th class="p-2">End Date</th>
<th class="p-2">Amount</th>
<th class="p-2">Status</th>
   <th class="p-2">Action</th>

          </tr>
        </thead>
        <tbody>
    `;

orders.forEach(o => {
      html += `
        <tr class="border-b">

          <!-- Customer -->
          <td class="p-2">
            ${o.userId?.name || "-"}<br>
            <span class="text-xs text-slate-500">
              ${o.userId?.email || ""}
            </span>
          </td>

          <!-- Plan -->
          <td class="p-2">
            ${o.planId?.name || o.planName || "-"}
          </td>

          <!-- Order Date -->
          <td class="p-2">
            ${o.createdAt
              ? new Date(o.createdAt).toLocaleDateString("en-IN")
              : "-"}
          </td>

          <!-- Start Date -->
          <td class="p-2">
            ${o.startDate
              ? new Date(o.startDate).toLocaleDateString("en-IN")
              : "-"}
          </td>

          <!-- End Date -->
          <td class="p-2">
            ${o.endDate
              ? new Date(o.endDate).toLocaleDateString("en-IN")
              : "-"}
          </td>

          <!-- Amount -->
          <td class="p-2">‚Çπ${o.amount || 0}</td>

          <!-- Status -->
          <td class="p-2">${o.status}</td>

          <!-- Action -->
          <td class="p-2 space-x-2">
            <button
              onclick="Orders.markDelivered('${o._id}')"
              class="text-xs underline"
            >
              Delivered
            </button>

            <button
              onclick="Orders.markSkipped('${o._id}')"
              class="text-xs underline text-red-600"
            >
              Skip
            </button>
          </td>

        </tr>
      `;
    });

    html += `
        </tbody>
      </table>
    `;

    ordersTableWrap.innerHTML = html;
  },

  async markDelivered(id){
    await authFetch(
      API_BASE + "/api/admin/orders/" + id + "/deliver",
      "PATCH"
    );
    this.load();
  },

  async markSkipped(id){
    const reason = prompt("Reason for skip?");
    if(!reason) return;

    await authFetch(
      API_BASE + "/api/admin/orders/" + id + "/skip",
      "PATCH",
      { reason }
    );
    this.load();
  }
};
  

/* ======================================================
DELIVERY MODULE
====================================================== */
const Delivery = {
  async load(){
    const list = await authFetch(API_BASE + "/api/admin/delivery/today");
    let html = `<div class="space-y-3">`;

    list.forEach(d=>{
      html += `
        <div class="glass p-4 rounded-xl shadow-glass flex justify-between">
          <div>
            <div class="font-semibold">${d.userId?.name || "-"}</div>
            <div class="text-xs">
              ${d.userId?.address?.area || "-"},
              ${d.userId?.address?.pincode || "-"}
            </div>
          </div>
          <div class="text-sm">${d.status || "-"}</div>
        </div>
      `;
    });

    html += "</div>";
    delivery.innerHTML = html;
  }
};

/* ======================================================
PAYMENTS & INVOICES MODULE
====================================================== */
const Payments = {
  async load(){
    const payments = await authFetch(
  API_BASE + "/api/admin/payments?t=" + Date.now()
);

    let html = `
      <table class="w-full bg-white rounded-xl shadow text-sm">
        <thead class="border-b">
          <tr>
            <th class="p-2 text-left">User</th>
            <th class="p-2">Txn</th>
            <th class="p-2">Amount</th>
            <th class="p-2">Status</th>
            <th class="p-2">Invoice</th>
            <th class="p-2">Action</th>
          </tr>
        </thead>
        <tbody>
    `;

    payments.forEach(p=>{
      html += `
        <tr class="border-b">
          <td class="p-2">
  ${p.userName || p.userId?.name || "-"}
</td>
          <td class="p-2">${p.txnId}</td>
          <td class="p-2">‚Çπ${p.amount}</td>
          <td class="p-2">${p.status}</td>
          <td class="p-2">
            <a href="${API_BASE}/api/admin/invoices/${p.invoiceId}/download" class="underline">Download</a>
          </td>
          <td class="p-2">
            <button onclick="Payments.refund('${p._id}')" class="text-xs underline text-red-600">Refund</button>
          </td>
        </tr>
      `;
    });

    html += "</tbody></table>";
    payments.innerHTML = html;
  },

  async refund(id){
    const note = prompt("Refund note");
    await authFetch(API_BASE + "/api/admin/payments/refund", "POST", { id, note });
    this.load();
  }
};

/* ======================================================
INVENTORY MODULE
====================================================== */
const Inventory = {
  async load(){
    const items = await authFetch(API_BASE + "/api/admin/inventory");
    let html = `
      <table class="w-full bg-white rounded-xl shadow text-sm">
        <thead class="border-b">
          <tr>
            <th class="p-2 text-left">Fruit</th>
            <th class="p-2">Stock (kg)</th>
            <th class="p-2">Daily Use</th>
            <th class="p-2">Status</th>
          </tr>
        </thead>
        <tbody>
    `;

    items.forEach(i=>{
      html += `
        <tr class="border-b">
          <td class="p-2">${i.name}</td>
          <td class="p-2">${i.stock}</td>
          <td class="p-2">${i.dailyUse}</td>
          <td class="p-2 ${i.stock < i.dailyUse ? 'text-red-600' : 'text-green-600'}">
            ${i.stock < i.dailyUse ? 'Low' : 'OK'}
          </td>
        </tr>
      `;
    });

    html += "</tbody></table>";
    inventory.innerHTML = html;
  }
};

/* ======================================================
CMS MODULE
====================================================== */
const CMS = {
  async load(){
    cms.innerHTML = `
      <div class="glass p-4 rounded-xl shadow-glass space-y-3 max-w-xl">
        <h3 class="font-semibold">Announcement Bar</h3>
        <input id="cmsAnnouncement" class="w-full border p-2 rounded" placeholder="Announcement text">
        <button onclick="CMS.save()" class="bg-brand-600 text-white px-4 py-2 rounded">Publish</button>
      </div>
    `;
  },

  async save(){
    await authFetch(API_BASE + "/api/admin/cms/announcement", "POST", {
      text: cmsAnnouncement.value
    });
    alert("Announcement published");
  }
};

/* ======================================================
SETTINGS MODULE (GST + SYSTEM)
====================================================== */
const Settings = {
  async load(){
    const s = await authFetch(API_BASE + "/api/admin/settings");
    settings.innerHTML = `
      <div class="glass p-4 rounded-xl shadow-glass max-w-xl space-y-3">
        <h3 class="font-semibold">System Settings</h3>

        <input id="gstNumber" class="w-full border p-2 rounded" placeholder="GST Number" value="${s.gstNumber||''}">
        <input id="cutoffTime" class="w-full border p-2 rounded" placeholder="Order Cutoff Time (22:00)" value="${s.cutoffTime||''}">

        <button onclick="Settings.save()" class="bg-brand-600 text-white px-4 py-2 rounded">
          Save Settings
        </button>
      </div>
    `;
  },

  async save(){
    await authFetch(API_BASE + "/api/admin/settings", "PUT", {
      gstNumber: gstNumber.value,
      cutoffTime: cutoffTime.value
    });
    alert("Settings saved");
  }
};

/* ======================================================
FINAL NAV HOOKS
====================================================== */
const oldShow = UI.show;
UI.show = function(id){
  oldShow(id);
  if(id==="users") Users.load();
  if(id==="plans") Plans.load();
  if(id==="orders") Orders.load();
  if(id==="delivery") Delivery.load();
  if(id==="payments") Payments.load();
  if(id==="inventory") Inventory.load();
  if(id==="cms") CMS.load();
  if(id==="settings") Settings.load();
};
</script>

</body>
</html>
