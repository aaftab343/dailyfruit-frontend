<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard — Daily Fruit Co.</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              500: '#22c55e',
              600: '#16a34a',
              700: '#15803d'
            }
          }
        }
      }
    }
  </script>

  <style>
    body {
      background: linear-gradient(to bottom, #f5faff, #eef2ff);
    }
  </style>
</head>

<body class="h-full bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100">

<div class="min-h-screen flex">

  <!-- SIDEBAR -->
  <aside class="w-64 bg-white/90 dark:bg-slate-900/90 border-r border-slate-200 dark:border-slate-800 hidden md:flex md:flex-col">
    <div class="px-4 py-4 border-b flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary-500 to-emerald-400 text-white flex items-center justify-center font-bold">
        DF
      </div>
      <div>
        <div class="font-semibold">Daily Fruit Co.</div>
        <div class="text-xs text-slate-500">Admin Panel</div>
      </div>
    </div>
  </aside>

  <!-- CONTENT -->
  <div class="flex-1 flex flex-col">

    <!-- HEADER -->
    <header class="border-b bg-white/80 backdrop-blur">
      <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between">
        <h1 class="text-xl font-semibold">Admin Dashboard</h1>
      </div>
    </header>

    <!-- LOGIN -->
    <main id="loginScreen" class="flex-1 flex items-center justify-center">
      <div class="max-w-sm w-full bg-white rounded-xl shadow p-6">
        <h2 class="text-lg font-semibold text-center mb-4">Admin Login</h2>

        <label class="text-xs">Admin Email</label>
        <input id="adminKeyInput" type="email"
          class="w-full mt-1 p-2 border rounded" placeholder="admin@dailyfruitco.in">

        <button id="loginBtn"
          class="mt-4 w-full bg-primary-600 hover:bg-primary-700 text-white py-2 rounded">
          Login
        </button>

        <p id="loginError" class="text-red-500 text-xs mt-2 hidden"></p>
      </div>
    </main>

    <!-- DASHBOARD -->
    <main id="dashboardScreen" class="hidden flex-1 overflow-y-auto p-6">
      <section class="grid grid-cols-4 gap-4 mb-6">
        <div class="bg-white p-4 rounded shadow">
          <p class="text-xs">Total Orders</p>
          <p id="statTotalOrders" class="text-2xl font-bold">0</p>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <p class="text-xs">Active</p>
          <p id="statActive" class="text-2xl font-bold text-green-600">0</p>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <p class="text-xs">Paused</p>
          <p id="statPaused" class="text-2xl font-bold text-yellow-600">0</p>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <p class="text-xs">Revenue</p>
          <p id="statRevenue" class="text-2xl font-bold">₹0</p>
        </div>
      </section>

      <section class="bg-white rounded shadow p-4">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b">
              <th class="p-2 text-left">Customer</th>
              <th class="p-2">Phone</th>
              <th class="p-2">Plan</th>
              <th class="p-2">Status</th>
              <th class="p-2">Created</th>
            </tr>
          </thead>
          <tbody id="ordersTable"></tbody>
        </table>
      </section>
    </main>

  </div>
</div>

<script>
/* ================= CONFIG ================= */
const API_BASE = "https://dailyfruit-backend.onrender.com";
const TOKEN_KEY = "admin_jwt_token";

const loginScreen = document.getElementById("loginScreen");
const dashboardScreen = document.getElementById("dashboardScreen");
const loginBtn = document.getElementById("loginBtn");
const adminKeyInput = document.getElementById("adminKeyInput");
const loginError = document.getElementById("loginError");

let ADMIN_TOKEN = localStorage.getItem(TOKEN_KEY);
let ALL_ORDERS = [];

/* ================= LOGIN ================= */
loginBtn.addEventListener("click", async () => {
  const email = adminKeyInput.value.trim();
  const password = prompt("Enter admin password");

  if (!email || !password) return;

  try {
    const res = await fetch(API_BASE + "/api/admin/auth/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.message || "Login failed");

    ADMIN_TOKEN = data.token;
    localStorage.setItem(TOKEN_KEY, ADMIN_TOKEN);

    loginScreen.classList.add("hidden");
    dashboardScreen.classList.remove("hidden");

    loadOrders();
  } catch (err) {
    loginError.textContent = err.message;
    loginError.classList.remove("hidden");
  }
});

/* ================= FETCH ================= */
async function authFetch(url) {
  const res = await fetch(url, {
    headers: {
      "Authorization": "Bearer " + ADMIN_TOKEN,
      "Content-Type": "application/json"
    }
  });

  if (res.status === 401) {
    localStorage.removeItem(TOKEN_KEY);
    location.reload();
  }
  return res.json();
}

/* ================= LOAD ORDERS ================= */
async function loadOrders() {
  ALL_ORDERS = await authFetch(API_BASE + "/api/admin/users");
  updateStats();
  renderTable();
}

/* ================= STATS ================= */
function updateStats() {
  document.getElementById("statTotalOrders").textContent = ALL_ORDERS.length;
  document.getElementById("statActive").textContent =
    ALL_ORDERS.filter(o => !o.isPaused).length;
  document.getElementById("statPaused").textContent =
    ALL_ORDERS.filter(o => o.isPaused).length;
  document.getElementById("statRevenue").textContent = "₹" + ALL_ORDERS.reduce((s,o)=>s+(o.amount||0),0);
}

/* ================= TABLE ================= */
function renderTable() {
  const table = document.getElementById("ordersTable");
  table.innerHTML = "";
  ALL_ORDERS.forEach(o => {
    table.innerHTML += `
      <tr class="border-b">
        <td class="p-2">
          ${o.name || "-"}<br>
          <span class="text-xs">${o.email || "-"}</span><br>
          <span class="text-xs">${o.address || "-"}</span>
        </td>
        <td class="p-2">${o.phone || "-"}</td>
        <td class="p-2">${o.planName || "-"}</td>
        <td class="p-2">${o.isPaused ? "Paused" : "Active"}</td>
        <td class="p-2">${new Date(o.createdAt).toLocaleDateString()}</td>
      </tr>
    `;
  });
}

/* ================= AUTO LOGIN ================= */
if (ADMIN_TOKEN) {
  loginScreen.classList.add("hidden");
  dashboardScreen.classList.remove("hidden");
  loadOrders();
}
</script>

</body>
</html>
