<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Coupons â€” Daily Fruit Co</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(180deg,#f8fafc,#eef7ff);
    }
    .glass {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(12px);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.4);
      box-shadow: 0 10px 30px rgba(15,23,42,0.12);
    }
    .btn { transition: all .15s ease }
    .btn:active { transform: scale(.97) }
  </style>
</head>

<body class="p-6">

<script>
const API_BASE = "https://dailyfruit-backend.onrender.com";
const token = localStorage.getItem("admin_token");
if (!token) location.href = "admin.html";
</script>

<!-- HEADER -->
<div class="max-w-7xl mx-auto mb-6 flex justify-between items-center">
  <h1 class="text-3xl font-extrabold">ðŸŽŸ Coupon Management</h1>
  <button onclick="openCreateModal()" class="btn px-5 py-2 rounded-full text-white font-semibold bg-gradient-to-r from-cyan-500 to-violet-600">
    + Create Coupon
  </button>
</div>

<!-- TABLE -->
<div class="max-w-7xl mx-auto glass p-4 overflow-x-auto">
  <table class="w-full text-sm">
    <thead class="border-b text-gray-600">
      <tr>
        <th>Code</th>
        <th>Discount</th>
        <th>Min</th>
        <th>Usage</th>
        <th>Plans</th>
        <th>Status</th>
        <th class="text-right">Actions</th>
      </tr>
    </thead>
    <tbody id="couponTable"></tbody>
  </table>
</div>

<!-- CREATE / EDIT MODAL -->
<div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
  <div class="glass w-full max-w-lg p-6">
    <h2 id="modalTitle" class="text-xl font-bold mb-4">Create Coupon</h2>

    <form id="couponForm" class="space-y-3">
      <input id="couponId" type="hidden">

      <input id="code" placeholder="Coupon Code" class="w-full border rounded px-3 py-2" required>

      <select id="discountType" class="w-full border rounded px-3 py-2">
        <option value="flat">Flat</option>
        <option value="percent">Percent</option>
      </select>

      <input id="discountValue" type="number" placeholder="Discount value" class="w-full border rounded px-3 py-2" required>
      <input id="minAmount" type="number" placeholder="Min order amount" class="w-full border rounded px-3 py-2">
      <input id="maxDiscount" type="number" placeholder="Max discount (for %)" class="w-full border rounded px-3 py-2">
      <input id="perUserLimit" type="number" placeholder="Per user limit" class="w-full border rounded px-3 py-2">
      <input id="validTo" type="date" class="w-full border rounded px-3 py-2" required>

      <div>
        <label class="text-xs font-semibold">Allowed Plans</label>
        <div id="plansCheckboxes" class="grid grid-cols-2 gap-2 text-xs mt-1"></div>
      </div>

      <button class="btn w-full py-2 rounded text-white font-semibold bg-gradient-to-r from-cyan-500 to-violet-600">
        Save Coupon
      </button>
    </form>

    <button onclick="closeModal()" class="mt-3 text-sm text-gray-500">Cancel</button>
  </div>
</div>

<!-- USAGE MODAL -->
<div id="usageModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
  <div class="glass w-full max-w-lg p-6">
    <h2 class="text-xl font-bold mb-4">Coupon Usage</h2>
    <ul id="usageList" class="text-sm space-y-2"></ul>
    <button onclick="closeUsage()" class="mt-4 text-sm text-gray-500">Close</button>
  </div>
</div>

<script>
let ALL_PLANS = [];

async function loadPlans() {
  ALL_PLANS = await fetch(API_BASE + "/api/admin/plans", {
    headers: { Authorization: "Bearer " + token }
  }).then(r=>r.json());
}

async function loadCoupons() {
  const coupons = await fetch(API_BASE + "/api/coupons", {
    headers: { Authorization: "Bearer " + token }
  }).then(r=>r.json());

  couponTable.innerHTML = "";

  coupons.forEach(c => {
    couponTable.innerHTML += `
      <tr class="border-b">
        <td class="font-bold">${c.code}</td>
        <td>${c.discountType === "flat" ? "â‚¹" : ""}${c.discountValue}${c.discountType==="percent"?"%":""}</td>
        <td>â‚¹${c.minAmount||0}</td>
        <td>
          ${c.totalUsed}/${c.usageLimit || "âˆž"}<br>
          <span class="text-xs">Per user: ${c.perUserLimit||1}</span>
        </td>
        <td class="text-xs">
          ${c.allowedPlanIds?.length ? c.allowedPlanIds.length+" plans" : "All"}
        </td>
        <td>
          <span class="px-2 py-1 rounded text-xs ${c.active?'bg-green-100 text-green-700':'bg-red-100 text-red-600'}">
            ${c.active?"Active":"Inactive"}
          </span>
        </td>
        <td class="text-right space-x-2">
          <button onclick='editCoupon(${JSON.stringify(c)})' class="text-blue-600">Edit</button>
          <button onclick="toggleCoupon('${c._id}')" class="text-orange-600">Toggle</button>
          <button onclick="viewUsage('${c._id}')" class="text-purple-600">Usage</button>
        </td>
      </tr>`;
  });
}

async function toggleCoupon(id) {
  await fetch(API_BASE + `/api/coupons/${id}/toggle`, {
    method: "PATCH",
    headers: { Authorization: "Bearer " + token }
  });
  loadCoupons();
}

function openCreateModal() {
  couponForm.reset();
  couponId.value = "";
  modalTitle.textContent = "Create Coupon";
  renderPlanCheckboxes([]);
  modal.classList.remove("hidden"); modal.classList.add("flex");
}

function editCoupon(c) {
  modalTitle.textContent = "Edit Coupon";
  couponId.value = c._id;
  code.value = c.code;
  discountType.value = c.discountType;
  discountValue.value = c.discountValue;
  minAmount.value = c.minAmount || "";
  maxDiscount.value = c.maxDiscount || "";
  perUserLimit.value = c.perUserLimit || 1;
  validTo.value = c.validTo.split("T")[0];
  renderPlanCheckboxes(c.allowedPlanIds || []);
  modal.classList.remove("hidden"); modal.classList.add("flex");
}

function closeModal(){ modal.classList.add("hidden"); modal.classList.remove("flex"); }

function renderPlanCheckboxes(selected){
  plansCheckboxes.innerHTML="";
  ALL_PLANS.forEach(p=>{
    plansCheckboxes.innerHTML += `
      <label>
        <input type="checkbox" value="${p._id}" ${selected.includes(p._id)?"checked":""}>
        ${p.name}
      </label>`;
  });
}

couponForm.onsubmit = async e => {
  e.preventDefault();
  const body = {
    code: code.value,
    discountType: discountType.value,
    discountValue:+discountValue.value,
    minAmount:+minAmount.value||0,
    maxDiscount:+maxDiscount.value||null,
    perUserLimit:+perUserLimit.value||1,
    validTo: validTo.value,
    allowedPlanIds:[...plansCheckboxes.querySelectorAll("input:checked")].map(i=>i.value)
  };

  const method = couponId.value ? "PUT" : "POST";
  const url = couponId.value ? `/api/coupons/${couponId.value}` : "/api/coupons";

  await fetch(API_BASE + url,{
    method,
    headers:{ "Content-Type":"application/json", Authorization:"Bearer "+token },
    body:JSON.stringify(body)
  });

  closeModal(); loadCoupons();
};

async function viewUsage(id){
  const data = await fetch(API_BASE + `/api/admin/coupons/${id}/usage`, {
    headers:{ Authorization:"Bearer "+token }
  }).then(r=>r.json());

  usageList.innerHTML = data.map(u=>`
    <li>ðŸ‘¤ ${u.userId?.email} â€” ${u.usedCount} times</li>
  `).join("");

  usageModal.classList.remove("hidden"); usageModal.classList.add("flex");
}

function closeUsage(){
  usageModal.classList.add("hidden"); usageModal.classList.remove("flex");
}

(async()=>{
  await loadPlans();
  loadCoupons();
})();
</script>

</body>
</html>
